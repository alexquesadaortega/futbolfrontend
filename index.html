<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fútbol 7 Generator (Supabase)</title>

<style>
  body { font-family: Arial, Helvetica, sans-serif; padding: 20px; background: #f3f4f6; color:#0f1724; }
  h1 { margin-bottom: 6px; }
  .box { background: #fff; padding: 14px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  input, select, button { padding: 8px; margin:6px 4px 4px 0; border-radius:6px; border:1px solid #ddd; }
  button { cursor:pointer; background:#06b6d4; color:#fff; border:none; }
  button.secondary { background:#10b981; }
  ul { padding-left: 18px; }
  .small { font-size: 13px; color:#374151; }
  .player-row { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
  .player-row button { background:#ef4444; padding:6px 8px; }
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h1>Generador de Equipos Fútbol 7</h1>
<p class="small">Conexión Supabase integrada.</p>

<!-- AUTH -->
<div class="box" id="authBox">
  <h2>Registro</h2>
  <input id="registerEmail" placeholder="Email">
  <input id="registerPassword" type="password" placeholder="Contraseña">
  <button id="btnRegister">Registrar</button>

  <hr>

  <h2>Login</h2>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="Contraseña">
  <button id="btnLogin">Login</button>

  <div id="authMsg" class="small" style="margin-top:8px;color:#6b7280"></div>
</div>

<!-- ADD PLAYER -->
<div class="box" id="addPlayerBox" style="display:none;">
  <h2>Añadir jugador</h2>
  <div class="player-row">
    <input id="playerName" placeholder="Nombre" style="flex:1">
    <select id="playerPosition">
      <option value="portero">Portero</option>
      <option value="defensa">Defensa</option>
      <option value="medio">Medio</option>
      <option value="delantero">Delantero</option>
    </select>
    <input id="playerSkill" type="number" placeholder="Media (1-10)" min="1" max="10" step="0.1">
    <button id="btnAddPlayer" class="secondary">Agregar</button>
  </div>

  <div id="playersListTitle" class="small" style="margin-top:8px">Jugadores guardados:</div>
  <div id="playersList" style="margin-top:8px"></div>
</div>

<!-- GENERATE TEAMS -->
<div class="box" id="generateBox" style="display:none;">
  <h2>Generar Equipos 7 vs 7</h2>
  <button id="btnGenerateTeams" class="primary" style="margin:10px 0;">Generar equipos balanceados</button>

  <div id="teamsResult" style="margin-top:15px;"></div>

  <div style="display:flex;gap:20px;margin-top:12px">
    <div style="flex:1">
      <h3>Negro</h3>
      <ul id="teamA"></ul>
      <div id="avgA" class="small"></div>
    </div>
    <div style="flex:1">
      <h3>Blanco</h3>
      <ul id="teamB"></ul>
      <div id="avgB" class="small"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const SUPABASE_URL = 'https://vayholflhqoyflbvuusa.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZheWhvbGZsaHFveWZsYnZ1dXNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzc5NjcsImV4cCI6MjA3ODY1Mzk2N30.QxD4_XbYlQarPRUcmoQQclw8cCnnzRiHZcYzSsUXGDA';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let localPlayers = [];
  let remotePlayers = [];

  const authMsg = document.getElementById('authMsg');
  const addPlayerBox = document.getElementById('addPlayerBox');
  const generateBox = document.getElementById('generateBox');
  const playersListEl = document.getElementById('playersList');

  document.getElementById('btnRegister').addEventListener('click', registerUser);
  document.getElementById('btnLogin').addEventListener('click', loginUser);
  document.getElementById('btnAddPlayer').addEventListener('click', onAddPlayerClicked);
  document.getElementById('btnGenerateTeams').addEventListener('click', onGenerateClicked);

  async function registerUser() {
    const email = document.getElementById('registerEmail').value.trim();
    const pass  = document.getElementById('registerPassword').value;
    if (!email || !pass) return alert('Introduce email y contraseña.');
    const { error } = await supabase.auth.signUp({ email, password: pass });
    if (error) authMsg.textContent = error.message;
    else authMsg.textContent = 'Registro enviado.';
  }

  async function loginUser() {
    const email = document.getElementById('loginEmail').value.trim();
    const pass  = document.getElementById('loginPassword').value;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
    if (error) { authMsg.textContent = error.message; return; }
    await loadRemotePlayersAndShowUI();
  }

  async function getCurrentUser(){
    const res = await supabase.auth.getUser();
    return res?.data?.user || null;
  }

  async function loadRemotePlayersAndShowUI() {
    addPlayerBox.style.display = 'block';
    generateBox.style.display = 'block';
    document.getElementById('authBox').style.display = 'none';

    remotePlayers = await loadPlayersFromSupabase();
    renderPlayersList();
  }

  async function loadPlayersFromSupabase(){
    const user = await getCurrentUser();
    if (!user) return [];
    const { data } = await supabase.from('players').select('*').eq('user_id', user.id);
    return data.map(r => ({ id: r.id, name: r.name, position: r.position, rating: r.rating }));
  }

  function renderPlayersList() {
    playersListEl.innerHTML = '';

    const list = [...remotePlayers, ...localPlayers];
    if (list.length === 0) {
      playersListEl.innerHTML = '<div class="small">No hay jugadores.</div>';
      return;
    }

    list.forEach(player => {
      const div = document.createElement('div');
      div.className = 'player-row';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.className = 'player-select';
      cb.dataset.id = player.id;

      const span = document.createElement('span');
      span.textContent = `${player.name} (${player.position}) - ${player.rating}`;

      div.appendChild(cb);
      div.appendChild(span);
      playersListEl.appendChild(div);
    });
  }

  let localIdCounter = 100000;

  async function onAddPlayerClicked() {
    const name = document.getElementById('playerName').value.trim();
    const position = document.getElementById('playerPosition').value;
    const rating = parseFloat(document.getElementById('playerSkill').value);

    const user = await getCurrentUser();
    if (user) {
      const { data } = await supabase.from('players').insert([{ user_id: user.id, name, position, rating }]).select();
      remotePlayers.push(data[0]);
    } else {
      localIdCounter++;
      localPlayers.push({ id: localIdCounter, name, position, rating });
    }

    renderPlayersList();
  }

  // ------------------------------
  // OBTENER JUGADORES MARCADOS
  // ------------------------------
  function getSelectedPlayers() {
    const checkboxes = document.querySelectorAll('.player-select:checked');
    const selected = [];

    checkboxes.forEach(cb => {
      const id = parseInt(cb.dataset.id);
      const player =
        remotePlayers.find(p => p.id == id) ||
        localPlayers.find(p => p.id == id);
      if (player) selected.push(player);
    });

    return selected;
  }

  // ------------------------------
  // GENERAR EQUIPOS
  // ------------------------------
  function generateBalancedTeams(players) {
    if (players.length < 14) return null;

    const teamsize = 7;

    const pos = {
      portero: [],
      defensa: [],
      medio: [],
      delantero: []
    };

    players.forEach(p => pos[p.position]?.push(p));

    if (pos.portero.length < 2) return null;
    if (pos.defensa.length < 6) return null;
    if (pos.medio.length < 2) return null;
    if (pos.delantero.length < 2) return null;

    function shuffle(a) { return a.sort(() => Math.random() - 0.5); }

    const teamA = [];
    const teamB = [];

    function assign(positionArray, minCount) {
      shuffle(positionArray);
      const a = positionArray.slice(0, minCount);
      const b = positionArray.slice(minCount, minCount * 2);
      teamA.push(...a);
      teamB.push(...b);
      return positionArray.slice(minCount * 2);
    }

    let rest = [];
    rest.push(...assign(pos.portero, 1));
    rest.push(...assign(pos.defensa, 3));
    rest.push(...assign(pos.medio, 1));
    rest.push(...assign(pos.delantero, 1));

    shuffle(rest);

    while (teamA.length < teamsize) teamA.push(rest.pop());
    while (teamB.length < teamsize) teamB.push(rest.pop());

    return { teamA, teamB };
  }

  // ------------------------------
  // CLICK EN GENERAR EQUIPOS
  // ------------------------------
  function onGenerateClicked() {
    const players = getSelectedPlayers();

    const result = generateBalancedTeams(players);
    if (!result) {
      alert("No se pudieron generar equipos con los jugadores seleccionados.");
      return;
    }

    const { teamA, teamB } = result;

    renderTeam("teamA", teamA);
    renderTeam("teamB", teamB);

    const avgA = teamA.reduce((a,b)=>a+b.rating,0)/7;
    const avgB = teamB.reduce((a,b)=>a+b.rating,0)/7;

    document.getElementById("avgA").textContent = "Media: " + avgA.toFixed(2);
    document.getElementById("avgB").textContent = "Media: " + avgB.toFixed(2);
  }

  function renderTeam(id, team) {
    const el = document.getElementById(id);
    el.innerHTML = "";
    team.forEach(p => {
      const li = document.createElement("li");
      li.textContent = `${p.name} (${p.position}) - ${p.rating}`;
      el.appendChild(li);
    });
  }
});
</script>

</body>
</html>
