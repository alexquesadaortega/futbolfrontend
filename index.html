<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Generador de Equipos Futbol 7</title>

<!-- ICONO Y COLOR DE LA WEB APP -->
<link rel="icon" href="icono.png" type="image/png">
<link rel="apple-touch-icon" href="icono.png">
<meta name="theme-color" content="#0f1724">
<link rel="manifest" href="manifest.json">

<style>
/* ----------------- TIPOGRAFÍA Y FONDO ----------------- */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
:root{ --bg1:#0f1724; --bg2:#1a2238; --accent:#06b6d4; --card-bg: rgba(255,255,255,0.05); --text:#e6eef6; }
body{
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
  color: var(--text); padding:10px; text-align:center; margin:0; min-height:100vh;
}
h1{ margin-bottom:10px; font-weight:600; color:#0ff0fc; letter-spacing:0.5px; text-shadow:0 0 8px rgba(0,255,255,0.4); }
.card{ background: var(--card-bg); backdrop-filter: blur(8px); padding:14px; border-radius:12px; margin:10px auto; width:95%; max-width:600px; text-align:left; }
.players-list { list-style:none; padding:0; max-height:200px; overflow:auto; }
.players-list li{ padding:6px; margin:3px 0; background: rgba(255,255,255,0.08); border-radius:8px; display:flex; justify-content:space-between; }
button{ background: linear-gradient(135deg,#06b6d4,#0ea5e9); color:#fff; cursor:pointer; margin:6px; padding:8px 14px; border-radius:8px; border:none; font-weight:600; font-size:14px; }
#fieldsContainer{ display:flex; justify-content:center; gap:20px; margin-top:25px; flex-wrap:wrap; }
.field{ position: relative; width:320px; height:480px; background-color: #0f4720; border:2px solid #fff; border-radius:10px; display:none; overflow:hidden; }
.field-title{ position:absolute; top:6px; width:100%; text-align:center; font-weight:600; color:#fff; font-size:13px; letter-spacing:0.5px; text-shadow:0 0 6px rgba(0,0,0,0.5);}
.player-card{ position:absolute; width:45px; height:50px; text-align:center; font-weight:600; color:#fff; cursor:grab; background:#000; border-radius:5px; overflow:hidden; }
.player-card img{ width:100%; height:100%; display:block; background:#000; }
.player-card span{ display:block; font-size:10px; margin-top:2px; word-wrap:break-word; background:#000; color:#fff; padding:1px 2px; border-radius:2px; }
.team-box{ background: rgba(255,255,255,0.03); padding:6px; border-radius:8px; display:flex; flex-direction:column; gap:3px; }
.team-title{ font-weight:600; margin-bottom:4px; color: var(--accent); }
.player-entry{ display:flex; justify-content:space-between; background: rgba(255,255,255,0.08); padding:4px 8px; border-radius:6px; font-size:13px; }
.login-card, #registerCard{ max-width:300px; margin:20px auto; padding:20px; background:var(--card-bg); border-radius:10px; text-align:center; }
.login-input, #registerCard input{ width:90%; margin:6px 0; padding:8px; border-radius:8px; border:none; background: rgba(255,255,255,0.1); color:#e6eef6; font-size:14px; }
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
  // ===== INICIALIZAR SUPABASE =====
  const supabaseUrl = 'https://vayholflhqoyflbvuusa.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZheWhvbGZsaHFveWZsYnZ1dXNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzc5NjcsImV4cCI6MjA3ODY1Mzk2N30.QxD4_XbYlQarPRUcmoQQclw8cCnnzRiHZcYzSsUXGDA';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // ===== VARIABLES GLOBALES =====
  let currentUser = null;
  let currentPlayers = [];
  let currentProposals = [];

  const shirtImages = { black: "camiseta-negra.png", white: "camiseta-blanca.png" };
  const positionOrder = { Portero:0, Defensa:1, Delantero:2, Mediocentro:3 };

  // ===== LOGIN =====
  async function loginUser() {
    const username = document.getElementById('loginUser').value.trim();
    const password = document.getElementById('loginPass').value.trim();
    const loginMsg = document.getElementById('loginMsg');
    loginMsg.textContent = '';
    if(!username || !password){ loginMsg.textContent='Introduce usuario y contraseña'; return; }

    const { data, error } = await supabase
      .from('users')
      .select('*')
      .eq('username', username)
      .eq('password', password)
      .single();

    if(error || !data){ loginMsg.textContent='Usuario o contraseña incorrectos'; return; }

    currentUser = data.username;
    await loadPlayers();
    document.getElementById('loginCard').style.display='none';
    document.getElementById('registerCard').style.display='none';
    document.getElementById('playersCard').style.display='block';
    document.getElementById('addPlayerCard').style.display='block';
  }

  // ===== REGISTRO =====
  async function registerUser() {
    const username = document.getElementById('regUser').value.trim();
    const password = document.getElementById('regPass').value.trim();
    const regMsg = document.getElementById('regMsg');
    regMsg.textContent = '';
    if(!username || !password){ regMsg.textContent='Introduce usuario y contraseña'; return; }

    const { error:exists } = await supabase.from('users').select('*').eq('username', username).single();
    if(exists){ regMsg.textContent='Usuario ya existe'; return; }

    const { error } = await supabase.from('users').insert({ username,password });
    if(error){ regMsg.textContent='Error al registrar'; return; }

    regMsg.textContent='Usuario registrado correctamente';
    document.getElementById('regUser').value='';
    document.getElementById('regPass').value='';
  }

  // ===== CARGAR JUGADORES =====
  async function loadPlayers(){
    const { data, error } = await supabase.from('players').select('*').eq('username', currentUser);
    currentPlayers = data || [];
    renderPlayerList();
  }

  // ===== AGREGAR JUGADOR =====
  async function addPlayer(){
    const name = document.getElementById('newName').value.trim();
    const pos = document.getElementById('newPos').value;
    const media = parseFloat(document.getElementById('newMedia').value);
    if(!name || isNaN(media) || media<0 || media>10){ alert('Datos incorrectos'); return; }

    const { error } = await supabase.from('players').insert({ username: currentUser, name, pos, media });
    if(error){ alert('Error al agregar jugador'); return; }
    currentPlayers.push({ username: currentUser, name, pos, media });
    renderPlayerList();
    document.getElementById('newName').value=''; document.getElementById('newMedia').value='';
  }

  // ===== ELIMINAR JUGADOR =====
  async function deletePlayer(idx){
    const p = currentPlayers[idx];
    if(!confirm(`Eliminar a ${p.name}?`)) return;
    await supabase.from('players').delete().eq('username', currentUser).eq('name', p.name);
    currentPlayers.splice(idx,1);
    renderPlayerList();
  }

  // ===== RENDER LISTA DE JUGADORES =====
  function renderPlayerList(){
    const container = document.getElementById('playersContainer');
    container.innerHTML='';
    currentPlayers.forEach((p, idx)=>{
      const li = document.createElement('li');
      li.innerHTML = `<label style="flex:1;"><input type="checkbox" data-index="${idx}"> ${p.name} (${p.pos}) [${p.media}]</label>
        <button onclick="deletePlayer(${idx})">Eliminar</button>`;
      container.appendChild(li);
    });
  }

  // ===== GENERACIÓN DE EQUIPOS BALANCEADOS FUTBOL 7 =====
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function averageMedia(team){ return team.reduce((s,p)=>s+(p.media||0),0)/(team.length||1); }
  function generateTeams(players){
    if(players.length<14){ alert('Se necesitan al menos 14 jugadores'); return null; }
    const maxPlayers=7;
    const posGroups={Portero:[],Defensa:[],Delantero:[],Mediocentro:[],Otros:[]};
    players.forEach(p=>{ posGroups[p.pos]?posGroups[p.pos].push(p):posGroups.Otros.push(p); });
    if(posGroups.Portero.length<2 || posGroups.Defensa.length<6 || posGroups.Delantero.length<2){ alert('No hay suficientes jugadores por posición'); return null; }
    let bestTeams=null, smallestDiff=Infinity;
    for(let it=0;it<500;it++){
      const porteros=[...posGroups.Portero], defensas=[...posGroups.Defensa], delanteros=[...posGroups.Delantero], mediocentros=[...posGroups.Mediocentro], otros=[...posGroups.Otros];
      shuffle(porteros); shuffle(defensas); shuffle(delanteros); shuffle(mediocentros); shuffle(otros);
      let teamA=[],teamB=[];
      teamA.push(porteros.shift()); teamB.push(porteros.shift());
      teamA.push(...defensas.splice(0,3)); teamB.push(...defensas.splice(0,3));
      teamA.push(delanteros.shift()); teamB.push(delanteros.shift());
      if(mediocentros.length>0){ teamA.push(mediocentros.shift()); if(mediocentros.length>0) teamB.push(mediocentros.shift()); }
      const remaining=[...porteros,...defensas,...delanteros,...mediocentros,...otros];
      while(teamA.length<maxPlayers && remaining.length>0) teamA.push(remaining.shift());
      while(teamB.length<maxPlayers && remaining.length>0) teamB.push(remaining.shift());
      if(teamA.length!==maxPlayers || teamB.length!==maxPlayers) continue;
      const diff=Math.abs(averageMedia(teamA)-averageMedia(teamB));
      if(diff<smallestDiff){ smallestDiff=diff; bestTeams=[teamA,teamB]; }
    }
    return bestTeams;
  }

  function generateProposals(){
    const selectedIndexes = [...document.querySelectorAll('#playersContainer input:checked')].map(chk=>Number(chk.dataset.index));
    if(selectedIndexes.length<14){ alert('Selecciona 14 jugadores'); return; }
    const selected = selectedIndexes.map(i=>currentPlayers[i]);
    const teams = generateTeams(selected);
    if(!teams) return;
    currentProposals=[teams];
    renderProposals();
  }

  function renderProposals(){
    const container=document.getElementById('proposalsContainer');
    container.innerHTML='';
    currentProposals.forEach(teams=>{
      const div=document.createElement('div'); div.className='proposal';
      ['Equipo Negro','Equipo Blanco'].forEach((title,idx)=>{
        const tDiv=document.createElement('div'); tDiv.className='team-box';
        const tTitle=document.createElement('div'); tTitle.className='team-title'; tTitle.textContent=title;
        tDiv.appendChild(tTitle);
        teams[idx].forEach(p=>{ const pDiv=document.createElement('div'); pDiv.className='player-entry'; pDiv.textContent=`${p.name} (${p.pos}) [${p.media}]`; tDiv.appendChild(pDiv); });
        div.appendChild(tDiv);
      });
      div.addEventListener('click',()=>applyTeams(teams));
      container.appendChild(div);
    });
    document.getElementById('proposalsCard').style.display='block';
  }

  function applyTeams(teams){
    const field1=document.getElementById('field1'), field2=document.getElementById('field2');
    field1.style.display='block'; field2.style.display='block';
    field1.innerHTML='<div class="field-title">Equipo Negro</div>'; field2.innerHTML='<div class="field-title">Equipo Blanco</div>';
    drawTeamOnField(field1,teams[0],'black'); drawTeamOnField(field2,teams[1],'white');
  }

  function drawTeamOnField(field,team,color){
    field.querySelectorAll('.player-card').forEach(n=>n.remove());
    const fw=field.clientWidth, fh=field.clientHeight;
    const positionsY={Portero:fh*0.85,Defensa:fh*0.62,Mediocentro:fh*0.45,Delantero:fh*0.28};
    team.forEach((p,i)=>{
      const div=document.createElement('div'); div.className='player-card';
      const img=document.createElement('img'); img.src=shirtImages[color]; div.appendChild(img);
      const span=document.createElement('span'); span.textContent=p.name; div.appendChild(span);
      const y=positionsY[p.pos]||positionsY.Defensa;
      const leftPx = Math.max(5, Math.round((fw/(team.length+1))*(i+1)-20));
      div.style.top=`${Math.round(y)}px`; div.style.left=`${leftPx}px`;
      field.appendChild(div);
    });
  }
</script>
</head>
<body>

<h1>GENERADOR DE EQUIPOS FUTBOL 7</h1>

<div class="login-card" id="loginCard">
  <strong>Login</strong><br>
  <input type="text" id="loginUser" placeholder="Usuario" class="login-input"><br>
  <input type="password" id="loginPass" placeholder="Contraseña" class="login-input"><br>
  <button onclick="loginUser()">Entrar</button>
  <div id="loginMsg" style="color:red;"></div>
</div>

<div id="registerCard">
  <strong>Registro</strong><br>
  <input type="text" id="regUser" placeholder="Usuario"><br>
  <input type="password" id="regPass" placeholder="Contraseña"><br>
  <button onclick="registerUser()">Registrar</button>
  <div id="regMsg" style="color:red;"></div>
</div>

<div class="card" id="playersCard" style="display:none;">
  <strong>Selecciona 14 jugadores:</strong>
  <ul id="playersContainer" class="players-list"></ul>
  <button onclick="generateProposals()">Generar equipo balanceado</button>
</div>

<div class="card" id="addPlayerCard" style="display:none;">
  <strong>Agregar jugador:</strong><br>
  <input type="text" id="newName" placeholder="Nombre"><br>
  <select id="newPos">
    <option value="Portero">Portero</option>
    <option value="Defensa">Defensa</option>
    <option value="Delantero">Delantero</option>
    <option value="Mediocentro">Mediocentro</option>
  </select><br>
  <input type="number" id="newMedia" placeholder="Media (0-10)" min="0" max="10"><br>
  <button onclick="addPlayer()">Agregar jugador</button>
</div>

<div class="card" id="proposalsCard" style="display:none;">
  <strong>Propuesta generada:</strong>
  <div id="proposalsContainer"></div>
</div>

<div id="fieldsContainer">
  <div><div id="field1" class="field"><div class="field-title">Equipo Negro</div></div></div>
  <div><div id="field2" class="field"><div class="field-title">Equipo Blanco</div></div></div>
</div>

</body>
</html>
