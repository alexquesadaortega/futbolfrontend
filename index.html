<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fútbol 7 Generator</title>

<style>
  body { font-family: Arial, Helvetica, sans-serif; padding: 20px; background: #f3f4f6; color:#0f1724; }
  h1 { margin-bottom: 6px; }
  .box { background: #fff; padding: 14px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  input, select, button { padding: 8px; margin:6px 4px 4px 0; border-radius:6px; border:1px solid #ddd; }
  button { cursor:pointer; background:#06b6d4; color:#fff; border:none; }
  button.secondary { background:#10b981; }
  ul { padding-left: 18px; }
  .small { font-size: 13px; color:#374151; }
  .player-row { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
  .player-row button { background:#ef4444; padding:6px 8px; }

  .football-field {
    position: relative;
    width: 350px;
    height: 550px;
    background: #1f8b4c;
    border: 4px solid #fff;
    border-radius: 10px;
    margin: 0 auto;
    box-sizing: border-box;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h1>Generador de Equipos Fútbol 7</h1>
<p class="small">Conexión Supabase integrada. Regístrate / inicia sesión y guarda tus jugadores en la nube.</p>

<!-- AUTH -->
<div class="box" id="authBox">
  <h2>Registro</h2>
  <input id="registerEmail" placeholder="Email">
  <input id="registerPassword" type="password" placeholder="Contraseña">
  <button id="btnRegister">Registrar</button>

  <hr>

  <h2>Login</h2>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="Contraseña">
  <button id="btnLogin">Login</button>

  <div id="authMsg" class="small" style="margin-top:8px;color:#6b7280"></div>
</div>

<!-- ADD PLAYER -->
<div class="box" id="addPlayerBox" style="display:none;">
  <h2>Añadir jugador</h2>
  <div class="player-row">
    <input id="playerName" placeholder="Nombre" style="flex:1">
    <select id="playerPosition">
      <option value="portero">Portero</option>
      <option value="defensa">Defensa</option>
      <option value="medio">Medio</option>
      <option value="delantero">Delantero</option>
    </select>
    <input id="playerSkill" type="number" placeholder="Media (1-10)" min="1" max="10" step="0.1">
    <button id="btnAddPlayer" class="secondary">Agregar</button>
  </div>

  <div id="playersListTitle" class="small" style="margin-top:8px">Jugadores guardados (tu cuenta):</div>
  <div id="playersList" style="margin-top:8px"></div>
</div>

<!-- GENERATE TEAMS -->
<div class="box" id="generateBox" style="display:none;">
  <h2>Generar Equipos 7 vs 7</h2>
  <p class="small">Se respetan mínimos: 1 portero / equipo, 3 defensas / equipo, 1 delantero / equipo. Rellena con otros hasta 7.</p>
  <button id="btnGenerateTeams" class="primary" style="margin:10px 0;">Generar equipos balanceados</button>

  <div id="teamsResult" style="margin-top:15px;"></div>

  <div id="fieldBox" class="box" style="margin-top:20px; display:none;">
    <h2>Campo (alineación editable)</h2>
    <div style="display:flex; gap:20px; justify-content:center;">
      <div>
        <h3 style="text-align:center;">Negro</h3>
        <div id="fieldA" class="football-field"></div>
      </div>
      <div>
        <h3 style="text-align:center;">Blanco</h3>
        <div id="fieldB" class="football-field"></div>
      </div>
    </div>
  </div>

  <div id="selectedLineup" class="box" style="margin-top:20px; display:none;">
   <h2>Alineación seleccionada</h2>
   <div style="display:flex;gap:20px;">
     <div style="flex:1">
       <h3>Negro</h3>
       <ul id="selectedA"></ul>
     </div>
     <div style="flex:1">
       <h3>Blanco</h3>
       <ul id="selectedB"></ul>
     </div>
   </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const SUPABASE_URL = 'https://vayholflhqoyflbvuusa.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZheWhvbGZsaHFveWZsYnZ1dXNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzc5NjcsImV4cCI6MjA3ODY1Mzk2N30.QxD4_XbYlQarPRUcmoQQclw8cCnnzRiHZcYzSsUXGDA';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let localPlayers = [];
  let remotePlayers = [];
  let localIdCounter = 100000;

  const authMsg = document.getElementById('authMsg');
  const addPlayerBox = document.getElementById('addPlayerBox');
  const generateBox = document.getElementById('generateBox');
  const playersListEl = document.getElementById('playersList');

  document.getElementById('btnRegister').addEventListener('click', registerUser);
  document.getElementById('btnLogin').addEventListener('click', loginUser);
  document.getElementById('btnAddPlayer').addEventListener('click', onAddPlayerClicked);
  document.getElementById('btnGenerateTeams').addEventListener('click', onGenerateTeamsClicked);

  async function registerUser() {
    const email = document.getElementById('registerEmail').value.trim();
    const pass  = document.getElementById('registerPassword').value;
    if (!email || !pass) return alert('Introduce email y contraseña.');
    authMsg.textContent = 'Registrando...';
    const { data, error } = await supabase.auth.signUp({ email, password: pass });
    if (error) { authMsg.textContent = error.message; console.error(error); return; }
    authMsg.textContent = 'Registro enviado. Confirma tu email si es necesario.';
  }

  async function loginUser() {
    const email = document.getElementById('loginEmail').value.trim();
    const pass  = document.getElementById('loginPassword').value;
    if (!email || !pass) return alert('Introduce email y contraseña.');
    authMsg.textContent = 'Iniciando sesión...';
    const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
    if (error) { authMsg.textContent = error.message; console.error(error); return; }
    authMsg.textContent = 'Login correcto. Cargando datos...';
    await loadRemotePlayersAndShowUI();
  }

  async function getCurrentUser(){
    const res = await supabase.auth.getUser();
    return res?.data?.user || null;
  }

  async function loadRemotePlayersAndShowUI() {
    const user = await getCurrentUser();
    if (!user) { authMsg.textContent = 'No hay usuario'; return; }
    addPlayerBox.style.display = 'block';
    generateBox.style.display = 'block';
    document.getElementById('authBox').style.display = 'none';
    remotePlayers = await loadPlayersFromSupabase();
    renderPlayersList();
    authMsg.textContent = `Conectado como ${user.email}`;
  }

  async function loadPlayersFromSupabase(){
    const user = await getCurrentUser();
    if (!user) return [];
    const { data, error } = await supabase.from('players').select('*').eq('user_id', user.id).order('num_id', { ascending: true });
    if (error) { console.error(error); return []; }
    return data.map(row => ({ id: row.id, num_id: row.num_id, name: row.name, position: row.position, rating: row.rating }));
  }

  function renderPlayersList() {
    playersListEl.innerHTML = '';
    const list = [...remotePlayers, ...localPlayers];
    if (list.length === 0) {
      playersListEl.innerHTML = '<div class="small">No hay jugadores todavía.</div>';
      return;
    }
    const positionOrderMap = { portero: 0, defensa: 1, medio: 2, delantero: 3 };
    list.sort((a, b) => positionOrderMap[a.position] - positionOrderMap[b.position]);
    list.forEach(player => {
      const div = document.createElement('div');
      div.className = 'player-row';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.className = 'player-select';
      cb.dataset.playerId = player.num_id;
      const span = document.createElement('span');
      span.textContent = `${player.name} (${player.position}) - ${player.rating}`;
      div.appendChild(cb);
      div.appendChild(span);
      playersListEl.appendChild(div);
    });
  }

  async function onAddPlayerClicked() {
    const name = document.getElementById('playerName').value.trim();
    const position = document.getElementById('playerPosition').value;
    const rating = parseFloat(document.getElementById('playerSkill').value);
    if (!name || !position || isNaN(rating) || rating < 1 || rating > 10) {
        return alert("La media debe estar entre 1 y 10 (se permiten decimales).");
    }

    const user = await getCurrentUser();
    if (user) {
        const { data, error } = await supabase.from('players').insert([{ user_id: user.id, name, position, rating }]).select();
        if (error) { console.error(error); alert('Error guardando en la nube'); return; }
        remotePlayers.push({ id: data[0].id, num_id: data[0].num_id, name, position, rating });
        renderPlayersList();
        document.getElementById('playerName').value = '';
        document.getElementById('playerSkill').value = '';
        alert('Jugador guardado en Supabase.');
    } else {
        localIdCounter++;
        localPlayers.push({ id: localIdCounter, num_id: localIdCounter, name, position, rating });
        renderPlayersList();
        document.getElementById('playerName').value = '';
        document.getElementById('playerSkill').value = '';
        alert('Jugador añadido localmente (inicia sesión para guardarlo en la nube).');
    }
  }

  // ---------------- Campo y jugadores ----------------
  function setupFieldLines(field) {
    field.innerHTML = '';
    const width = field.clientWidth;
    const height = field.clientHeight;

    // Línea central vertical
    const vertLine = document.createElement('div');
    vertLine.style.position = 'absolute';
    vertLine.style.left = '50%';
    vertLine.style.top = '0';
    vertLine.style.width = '2px';
    vertLine.style.height = '100%';
    vertLine.style.background = '#fff';
    field.appendChild(vertLine);

    // Área portero superior
    const topArea = document.createElement('div');
    topArea.style.position = 'absolute';
    topArea.style.top = '0';
    topArea.style.left = '0';
    topArea.style.width = '100%';
    topArea.style.height = '70px';
    topArea.style.border = '2px solid #fff';
    topArea.style.borderTop = 'none';
    field.appendChild(topArea);

    // Área portero inferior
    const bottomArea = document.createElement('div');
    bottomArea.style.position = 'absolute';
    bottomArea.style.bottom = '0';
    bottomArea.style.left = '0';
    bottomArea.style.width = '100%';
    bottomArea.style.height = '70px';
    bottomArea.style.border = '2px solid #fff';
    bottomArea.style.borderBottom = 'none';
    field.appendChild(bottomArea);

    // Línea central horizontal
    const horLine = document.createElement('div');
    horLine.style.position = 'absolute';
    horLine.style.top = '50%';
    horLine.style.left = '0';
    horLine.style.width = '100%';
    horLine.style.height = '2px';
    horLine.style.background = '#fff';
    field.appendChild(horLine);

    // Círculo central
    const circle = document.createElement('div');
    circle.style.position = 'absolute';
    circle.style.top = '50%';
    circle.style.left = '50%';
    circle.style.width = '80px';
    circle.style.height = '80px';
    circle.style.border = '2px solid #fff';
    circle.style.borderRadius = '50%';
    circle.style.transform = 'translate(-50%, -50%)';
    field.appendChild(circle);
  }

  function placePlayersOnField(teamA, teamB) {
    const fieldA = document.getElementById("fieldA");
    const fieldB = document.getElementById("fieldB");

    setupFieldLines(fieldA);
    setupFieldLines(fieldB);

    placeTeamOnField(teamA, "negra", fieldA);
    placeTeamOnField(teamB, "blanca", fieldB);

    document.getElementById("fieldBox").style.display = "block";
  }

  function placeTeamOnField(team, color, field) {
    field.querySelectorAll(".player-dot-wrapper")?.forEach(el => el.remove());

    const positions = { portero: [], defensa: [], medio: [], delantero: [] };
    team.forEach(p => positions[p.position].push(p));

    const containerWidth = field.clientWidth;
    const containerHeight = field.clientHeight;

    for (const pos in positions) {
      const players = positions[pos];
      if (players.length === 0) continue;
      const yMap = { portero: containerHeight - 100, defensa: 350, medio: 200, delantero: 80 };
      const y = yMap[pos] || containerHeight / 2;
      const spacing = 70;
      const startX = (containerWidth - (players.length - 1) * spacing) / 2;
      players.forEach((player, i) => {
        const spot = { x: startX + i * spacing, y };
        createPlayerEl(player, color, spot, field);
      });
    }
  }

  function createPlayerEl(player, color, spot, container) {
    const wrapper = document.createElement("div");
    wrapper.className = "player-dot-wrapper";
    wrapper.style.position = "absolute";
    wrapper.style.left = spot.x + "px";
    wrapper.style.top = spot.y + "px";
    wrapper.style.textAlign = "center";
    wrapper.style.cursor = "grab";

    const img = document.createElement("img");
    img.src = color === "negra" ? "camiseta-negra.png" : "camiseta-blanca.png";
    img.style.width = "60px";
    img.style.height = "60px";
    wrapper.appendChild(img);

    const name = document.createElement("div");
    name.textContent = player.name;
    name.style.fontSize = "12px";
    name.style.marginTop = "4px";
    wrapper.appendChild(name);

    makeDraggableWithSnap(wrapper, container);
    container.appendChild(wrapper);
  }

  function makeDraggableWithSnap(el, container) {
    let offsetX, offsetY, isDragging = false;
    const snapSize = 10;

    const startDrag = (clientX, clientY) => {
      const rect = el.getBoundingClientRect();
      offsetX = clientX - rect.left;
      offsetY = clientY - rect.top;
      isDragging = true;
      el.style.zIndex = 9999;
    };

    const drag = (clientX, clientY) => {
      if (!isDragging) return;
      const rect = container.getBoundingClientRect();
      let newX = clientX - rect.left - offsetX;
      let newY = clientY - rect.top - offsetY;
      newX = Math.max(0, Math.min(newX, container.clientWidth - el.offsetWidth));
      newY = Math.max(0, Math.min(newY, container.clientHeight - el.offsetHeight));
      newX = Math.round(newX / snapSize) * snapSize;
      newY = Math.round(newY / snapSize) * snapSize;
      el.style.left = newX + "px";
      el.style.top = newY + "px";
    };

    const stopDrag = () => { isDragging = false; };

    el.addEventListener("mousedown", e => startDrag(e.clientX, e.clientY));
    window.addEventListener("mousemove", e => drag(e.clientX, e.clientY));
    window.addEventListener("mouseup", stopDrag);

    el.addEventListener("touchstart", e => startDrag(e.touches[0].clientX, e.touches[0].clientY));
    window.addEventListener("touchmove", e => { e.preventDefault(); drag(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
    window.addEventListener("touchend", stopDrag);
  }

  // -------------- Generar equipos ---------------
  function onGenerateTeamsClicked() {
    const selected = document.querySelectorAll(".player-select:checked");
    if (selected.length < 14) return alert("Selecciona al menos 14 jugadores para 2 equipos de 7.");
    const allPlayers = [];
    selected.forEach(cb => {
      const player = [...remotePlayers, ...localPlayers].find(p => p.num_id == cb.dataset.playerId);
      if (player) allPlayers.push(player);
    });

    const teamA = [];
    const teamB = [];
    // Asignar mínimo 1 portero, 3 defensas, 1 delantero
    ["portero","defensa","medio","delantero"].forEach(pos => {
      const players = allPlayers.filter(p=>p.position==pos);
      players.forEach((p,i) => i%2===0 ? teamA.push(p) : teamB.push(p));
    });

    // Rellenar hasta 7
    const allAssigned = [...teamA,...teamB];
    allPlayers.filter(p=>!allAssigned.includes(p)).forEach((p,i)=>i%2===0?teamA.push(p):teamB.push(p));

    // Mostrar en listado
    const selA = document.getElementById("selectedA");
    const selB = document.getElementById("selectedB");
    selA.innerHTML = ""; selB.innerHTML = "";
    teamA.forEach(p=>selA.innerHTML+=`<li>${p.name} (${p.position})</li>`);
    teamB.forEach(p=>selB.innerHTML+=`<li>${p.name} (${p.position})</li>`);

    document.getElementById("selectedLineup").style.display="block";
    placePlayersOnField(teamA, teamB);
  }
});
</script>

</body>
</html>
