<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fútbol 7 Generator (Supabase)</title>

<style>
  body { font-family: Arial, Helvetica, sans-serif; padding: 20px; background: #f3f4f6; color:#0f1724; }
  h1 { margin-bottom: 6px; }
  .box { background: #fff; padding: 14px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  input, select, button { padding: 8px; margin:6px 4px 4px 0; border-radius:6px; border:1px solid #ddd; }
  button { cursor:pointer; background:#06b6d4; color:#fff; border:none; }
  button.secondary { background:#10b981; }
  ul { padding-left: 18px; }
  .small { font-size: 13px; color:#374151; }
  .player-row { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
  .player-row button { background:#ef4444; padding:6px 8px; }
</style>

<!-- Supabase CDN (v2) - carga antes de usar -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h1>Generador de Equipos Fútbol 7</h1>
<p class="small">Conexión Supabase integrada. Regístrate / inicia sesión y guarda tus jugadores en la nube.</p>

<!-- AUTH -->
<div class="box" id="authBox">
  <h2>Registro</h2>
  <input id="registerEmail" placeholder="Email">
  <input id="registerPassword" type="password" placeholder="Contraseña">
  <button id="btnRegister">Registrar</button>

  <hr>

  <h2>Login</h2>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="Contraseña">
  <button id="btnLogin">Login</button>

  <div id="authMsg" class="small" style="margin-top:8px;color:#6b7280"></div>
</div>

<!-- ADD PLAYER -->
<div class="box" id="addPlayerBox" style="display:none;">
  <h2>Añadir jugador</h2>
  <div class="player-row">
    <input id="playerName" placeholder="Nombre" style="flex:1">
    <select id="playerPosition">
      <option value="portero">Portero</option>
      <option value="defensa">Defensa</option>
      <option value="medio">Medio</option>
      <option value="delantero">Delantero</option>
    </select>
    <input id="playerSkill" type="number" placeholder="Media (1-10)" min="1" max="10" step="0.1">
    <button id="btnAddPlayer" class="secondary">Agregar</button>
  </div>

  <div id="playersListTitle" class="small" style="margin-top:8px">Jugadores guardados (tu cuenta):</div>
  <div id="playersList" style="margin-top:8px"></div>
</div>

<!-- GENERATE TEAMS -->
<div class="box" id="generateBox" style="display:none;">
  <h2>Generar Equipos 7 vs 7</h2>
  <p class="small">Se respetan mínimos: 1 portero / equipo, 3 defensas / equipo, 1 delantero / equipo. Rellena con otros hasta 7.</p>
    <!-- BOTÓN PARA GENERAR -->
  <button id="btnGenerateTeams" class="primary" style="margin:10px 0;">Generar equipos balanceados</button>

  <!-- DONDE SE VAN A MOSTRAR LOS EQUIPOS -->
  <div id="teamsResult" style="margin-top:15px;"></div>

  <div style="display:flex;gap:20px;margin-top:12px">
    <div style="flex:1">
      <h3>Equipo A</h3>
      <ul id="teamA"></ul>
      <div id="avgA" class="small"></div>
    </div>
    <div style="flex:1">
      <h3>Equipo B</h3>
      <ul id="teamB"></ul>
      <div id="avgB" class="small"></div>
    </div>
  </div>
</div>

<script>
/*
  index.html con Supabase integrado.
  Requisitos Previos en Supabase:
  - Tabla "players": id (auto), user_id (uuid), name (text), position (text), rating (int)
  - Tabla "teams": id (auto), user_id (uuid), team_a (jsonb), team_b (jsonb), created_at (timestamp default now())
*/

document.addEventListener('DOMContentLoaded', () => {
  // ----------------------------
  // CONFIGURA TUS CREDENCIALES
  // ----------------------------
  const SUPABASE_URL = 'https://vayholflhqoyflbvuusa.supabase.co'; // tu URL
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZheWhvbGZsaHFveWZsYnZ1dXNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzc5NjcsImV4cCI6MjA3ODY1Mzk2N30.QxD4_XbYlQarPRUcmoQQclw8cCnnzRiHZcYzSsUXGDA';

  // Crear cliente Supabase (YA se puede usar porque el CDN ya se cargó)
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // Estado local
  let localPlayers = []; // se usa para añadir sin guardar / pruebas
  let remotePlayers = []; // jugadores cargados desde Supabase para el usuario

  // Elementos UI
  const authMsg = document.getElementById('authMsg');
  const addPlayerBox = document.getElementById('addPlayerBox');
  const generateBox = document.getElementById('generateBox');
  const playersListEl = document.getElementById('playersList');
  const playersListTitle = document.getElementById('playersListTitle');

  // Botones
  document.getElementById('btnRegister').addEventListener('click', registerUser);
  document.getElementById('btnLogin').addEventListener('click', loginUser);
  document.getElementById('btnAddPlayer').addEventListener('click', onAddPlayerClicked);
  document.getElementById('btnGenerate').addEventListener('click', generateTeamsFromSupabase);
  document.getElementById('btnGenerateLocal').addEventListener('click', generateTeamsFromLocal);
  

  // ------------------------
  // AUTH: registro y login
  // ------------------------
  async function registerUser() {
    const email = document.getElementById('registerEmail').value.trim();
    const pass  = document.getElementById('registerPassword').value;
    if (!email || !pass) return alert('Introduce email y contraseña.');

    authMsg.textContent = 'Registrando...';
    const { data, error } = await supabase.auth.signUp({ email, password: pass });
    if (error) { authMsg.textContent = error.message; console.error(error); return; }
    authMsg.textContent = 'Registro enviado. Confirma tu email si es necesario.';
  }

  async function loginUser() {
    const email = document.getElementById('loginEmail').value.trim();
    const pass  = document.getElementById('loginPassword').value;
    if (!email || !pass) return alert('Introduce email y contraseña.');

    authMsg.textContent = 'Iniciando sesión...';
    const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
    if (error) { authMsg.textContent = error.message; console.error(error); return; }

    authMsg.textContent = 'Login correcto. Cargando datos...';
    // Después de login, cargar jugadores remotos y revelar secciones
    await loadRemotePlayersAndShowUI();
  }

  // ------------------------
  // CARGAR / MOSTRAR JUGADORES
  // ------------------------
  async function loadRemotePlayersAndShowUI() {
    const user = await getCurrentUser();
    if (!user) { authMsg.textContent = 'No hay usuario'; return; }

    // Mostrar secciones
    addPlayerBox.style.display = 'block';
    generateBox.style.display = 'block';
    document.getElementById('authBox').style.display = 'none';

    // Cargar jugadores del usuario
    remotePlayers = await loadPlayersFromSupabase();
    renderPlayersList();
    authMsg.textContent = `Conectado como ${user.email}`;
  }

  async function getCurrentUser(){
    const res = await supabase.auth.getUser();
    return res?.data?.user || null;
  }

  async function loadPlayersFromSupabase(){
    const user = await getCurrentUser();
    if (!user) return [];
    const { data, error } = await supabase.from('players').select('*').eq('user_id', user.id).order('id', { ascending: true });
    if (error) { console.error(error); return []; }
    return data.map(row => ({ id: row.id, name: row.name, position: row.position, rating: row.rating }));
  }

  function renderPlayersList(){
  playersListEl.innerHTML = '';
  const list = remotePlayers.length ? remotePlayers : localPlayers;
  if (list.length === 0) {
    playersListEl.innerHTML = '<div class="small">No hay jugadores todavía.</div>';
    return;
  }

  list.forEach(p => {
    const div = document.createElement('div');
    div.className = 'player-row';

    // Checkbox para seleccionar jugadores
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.className = 'player-select';
    cb.dataset.playerId = p.id;

    // Nombre + posición
    const label = document.createElement('span');
    label.textContent = `${p.name} (${p.position})`;

    // Botones
    const editBtn = document.createElement('button');
    editBtn.textContent = 'Editar';
    editBtn.className = 'editPlayerBtn';
    editBtn.dataset.id = p.id;

    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Eliminar';
    deleteBtn.className = 'deletePlayerBtn';
    deleteBtn.dataset.id = p.id;

    div.appendChild(cb);
    div.appendChild(label);
    div.appendChild(editBtn);
    div.appendChild(deleteBtn);

    playersListEl.appendChild(div);
  });
}

function getSelectedPlayers(){
  const selected = [];
  document.querySelectorAll('.player-select:checked').forEach(cb => {
    const id = Number(cb.dataset.playerId);
    const p = remotePlayers.find(pl => pl.id === id);
    if (p) selected.push(p);
  });
  return selected;
}

  // ------------------------
  // AÑADIR JUGADOR (local y / o remoto)
  // ------------------------
  async function onAddPlayerClicked() {
    const name = document.getElementById('playerName').value.trim();
    const position = document.getElementById('playerPosition').value;
    const rating = parseFloat(document.getElementById('playerSkill').value);

    if (!name || !position || isNaN(rating) || rating < 1 || rating > 10) {
        return alert("La media debe estar entre 1 y 10 (se permiten decimales).");
    }


    // Si el usuario está logueado, guardamos en Supabase; si no, lo guardamos localmente
    const user = await getCurrentUser();
    if (user) {
      const { data, error } = await supabase.from('players').insert([{ user_id: user.id, name, position, rating }]).select();
      if (error) { console.error(error); alert('Error guardando en la nube'); return; }
      // data es array con row insertada
      remotePlayers.push({ id: data[0].id, name: data[0].name, position: data[0].position, rating: data[0].rating });
      renderPlayersList();
      document.getElementById('playerName').value = '';
      document.getElementById('playerSkill').value = '';
      alert('Jugador guardado en Supabase.');
    } else {
      localPlayers.push({ name, position, rating });
      renderPlayersList();
      document.getElementById('playerName').value = '';
      document.getElementById('playerSkill').value = '';
      alert('Jugador añadido localmente (inicia sesión para guardarlo en la nube).');
    }
  }

  // ------------------------
  // GENERACIÓN EQUIPOS (LÓGICA FUT7)
  // ------------------------
  // Recibe array de jugadores con {name, position, rating}
  function generateBalancedTeamsFromArray(playersArray) {
    // Validaciones básicas
    if (!Array.isArray(playersArray) || playersArray.length < 14) {
      throw new Error('Se necesitan mínimo 14 jugadores.');
    }

    // Normalizar posiciones a claves internas
    const posMap = {
      portero: 'portero',
      defensa: 'defensa',
      medio: 'medio',
      delantero: 'delantero',
      POR: 'portero', DEF: 'defensa', MED: 'medio', DEL: 'delantero'
    };
    // Agrupar
    const byPos = { portero: [], defensa: [], medio: [], delantero: [], otros: [] };
    playersArray.forEach(p => {
      const pos = (p.position || '').toString().toLowerCase();
      const key = posMap[pos] || (byPos[pos] ? pos : 'otros');
      if (byPos[key]) byPos[key].push(p);
      else byPos.otros.push(p);
    });

    // Requisitos mínimos
    if (byPos.portero.length < 2) throw new Error('Se necesitan al menos 2 porteros (1 por equipo).');
    if (byPos.defensa.length < 6) throw new Error('Se necesitan al menos 6 defensas (3 por equipo).');
    if (byPos.delantero.length < 2) throw new Error('Se necesitan al menos 2 delanteros (1 por equipo).');

    // Ordenamos cada grupo por rating descendente (para repartir alternando)
    ['portero','defensa','medio','delantero','otros'].forEach(k => {
      byPos[k].sort((a,b) => b.rating - a.rating);
    });

    let teamA = [], teamB = [];

    // Helper para repartir alternativamente desde un array (pop highest and alternate)
    function alternateDistribute(arr, count) {
      for (let i = 0; i < count; i++) {
        const item = arr.shift(); // take highest first
        if (!item) continue;
        if (i % 2 === 0) teamA.push(item);
        else teamB.push(item);
      }
    }

    // 1 portero por equipo -> repartir top2 (mejores)
    alternateDistribute(byPos.portero, 2);

    // 3 defensas por equipo -> tomar 6 mejores y alternar
    alternateDistribute(byPos.defensa, 6);

    // 1 delantero por equipo -> tomar 2 mejores
    alternateDistribute(byPos.delantero, 2);

    // Rellenar con MEDIOS y luego OTROS por rating descendente para balancear
    const remainder = [...byPos.medio, ...byPos.otros].sort((a,b) => b.rating - a.rating);

    // Rellenar hasta 7 cada equipo intentando balancear medias
    function avg(team) { return team.reduce((s,p) => s + (p.rating||0), 0) / (team.length||1); }

    while ((teamA.length < 7 || teamB.length < 7) && remainder.length > 0) {
      // siempre añadir al equipo con menor media
      const aAvg = avg(teamA), bAvg = avg(teamB);
      const next = remainder.shift();
      if (teamA.length >= 7) teamB.push(next);
      else if (teamB.length >= 7) teamA.push(next);
      else if (aAvg <= bAvg) teamA.push(next);
      else teamB.push(next);
    }

    // Sanity: si aún no hay 7 por equipo, algo fallo
    if (teamA.length !== 7 || teamB.length !== 7) {
      throw new Error('No se pudieron rellenar ambos equipos a 7 jugadores.');
    }

    // Orden final por rating descendente dentro de cada equipo (opcional)
    teamA.sort((a,b) => b.rating - a.rating);
    teamB.sort((a,b) => b.rating - a.rating);

    return { teamA, teamB };
  }

  // ------------------------
  // GENERAR USANDO SUPABASE (remotePlayers)
  // ------------------------
  async function generateTeamsFromSupabase() {
    // recargar remotamente para estar seguros
    remotePlayers = await loadPlayersFromSupabase();
    try {
      const { teamA, teamB } = generateBalancedTeamsFromArray(remotePlayers);
      showTeams(teamA, teamB);
      await saveTeamsToSupabase(teamA, teamB);
      alert('Equipos generados y guardados en Supabase.');
    } catch (err) {
      alert('Error: ' + err.message);
      console.error(err);
    }
  }

  // ------------------------
  // GENERAR USANDO localPlayers (no guardado)
  // ------------------------
  async function generateTeamsFromLocal() {
    const source = localPlayers.length ? localPlayers : (remotePlayers.length ? remotePlayers : []);
    try {
      const { teamA, teamB } = generateBalancedTeamsFromArray(source);
      showTeams(teamA, teamB);
      // no guardamos si es local; si quieres guardarlos, se puede añadir
    } catch (err) {
      alert('Error: ' + err.message);
      console.error(err);
    }
  }

  // ------------------------
  // MOSTRAR EQUIPOS EN UI
  // ------------------------
  function showTeams(teamA, teamB) {
    const ulA = document.getElementById('teamA');
    const ulB = document.getElementById('teamB');
    ulA.innerHTML = ''; ulB.innerHTML = '';

    teamA.forEach(p => {
      const li = document.createElement('li');
      li.textContent = `${p.name} — ${p.position} — ${p.rating}`;
      ulA.appendChild(li);
    });
    teamB.forEach(p => {
      const li = document.createElement('li');
      li.textContent = `${p.name} — ${p.position} — ${p.rating}`;
      ulB.appendChild(li);
    });

    const avgA = Math.round(teamA.reduce((s,p) => s + p.rating, 0) / teamA.length);
    const avgB = Math.round(teamB.reduce((s,p) => s + p.rating, 0) / teamB.length);
    document.getElementById('avgA').textContent = `Media: ${avgA}`;
    document.getElementById('avgB').textContent = `Media: ${avgB}`;
  }

  // ------------------------
  // GUARDAR EQUIPOS EN SUPABASE
  // ------------------------
  async function saveTeamsToSupabase(teamA, teamB) {
    const user = await getCurrentUser();
    if (!user) return;
    const payload = {
      user_id: user.id,
      team_a: teamA,
      team_b: teamB
    };
    const { data, error } = await supabase.from('teams').insert([payload]);
    if (error) { console.error('Error guardando teams:', error); return; }
    return data;
  }

  // ------------------------
  // Util: cargar jugadores (expuesto para debugging)
  // ------------------------
  async function loadPlayersDebug() {
    const rows = await loadPlayersFromSupabase();
    console.log('remotePlayers', rows);
  }

  // ------------------------
  // Exponer en window para debugging rápido (opcional)
  // ------------------------
  window._supabase = supabase;
  window._localPlayers = localPlayers;
  window._remotePlayers = remotePlayers;
  window.loadPlayersDebug = loadPlayersDebug;

}); // DOMContentLoaded end
</script>

</body>
</html>
