<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fútbol 7 Generator (Supabase)</title>

<style>
  body { font-family: Arial, Helvetica, sans-serif; padding: 20px; background: #f3f4f6; color:#0f1724; }
  h1 { margin-bottom: 6px; }
  .box { background: #fff; padding: 14px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  input, select, button { padding: 8px; margin:6px 4px 4px 0; border-radius:6px; border:1px solid #ddd; }
  button { cursor:pointer; background:#06b6d4; color:#fff; border:none; }
  button.secondary { background:#10b981; }
  ul { padding-left: 18px; }
  .small { font-size: 13px; color:#374151; }
  .player-row { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
  .player-row button { background:#ef4444; padding:6px 8px; }
  .player-dot {
    position:absolute;
    width:70px;
    height:30px;
    background:white;
    border-radius:12px;
    text-align:center;
    line-height:30px;
    cursor:grab;
    font-size:13px;
    font-weight:bold;
    box-shadow:0 0 6px rgba(0,0,0,0.5);
    user-select:none;
  }
  .player-dot:active { cursor:grabbing; }

  .football-field {
  position: relative;
  width: 350px;
  height: 550px;
  background: #1f8b4c;
  border: 4px solid #fff;
  border-radius: 10px;
  margin: 0 auto;
}

/* Línea central horizontal */
.football-field::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  width: 100%;
  height: 2px;
  background: #fff;
  transform: translateY(-50%);
}


/* Círculo central */
.football-field::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 80px;
  height: 80px;
  border: 2px solid #fff;
  border-radius: 50%;
  transform: translate(-50%, -50%);
}

/* Área portero superior */
.football-field .goal-area-top {
  position: absolute;
  top: 0;
  left: 90px;       /* centrar horizontalmente según ancho del campo */
  width: 170px;      /* ancho del área */
  height: 70px;      /* alto del área */
  border: 2px solid #fff;
  border-top: none;
}

/* Área portero inferior */
.football-field .goal-area-bottom {
  position: absolute;
  bottom: 0;
  left: 90px;
  width: 170px;
  height: 70px;
  border: 2px solid #fff;
  border-bottom: none;
}


</style>

<!-- Supabase CDN (v2) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h1>Generador de Equipos Fútbol 7</h1>
<p class="small">Conexión Supabase integrada. Regístrate / inicia sesión y guarda tus jugadores en la nube.</p>

<!-- AUTH -->
<div class="box" id="authBox">
  <h2>Registro</h2>
  <input id="registerEmail" placeholder="Email">
  <input id="registerPassword" type="password" placeholder="Contraseña">
  <button id="btnRegister">Registrar</button>

  <hr>

  <h2>Login</h2>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="Contraseña">
  <button id="btnLogin">Login</button>

  <div id="authMsg" class="small" style="margin-top:8px;color:#6b7280"></div>
</div>

<!-- ADD PLAYER -->
<div class="box" id="addPlayerBox" style="display:none;">
  <h2>Añadir jugador</h2>
  <div class="player-row">
    <input id="playerName" placeholder="Nombre" style="flex:1">
    <select id="playerPosition">
      <option value="portero">Portero</option>
      <option value="defensa">Defensa</option>
      <option value="delantero">Delantero</option>
    </select>
    <input id="playerSkill" type="number" placeholder="Media (1-10)" min="1" max="10" step="0.1">
    <button id="btnAddPlayer" class="secondary">Agregar</button>
  </div>

  <div id="playersListTitle" class="small" style="margin-top:8px">Jugadores guardados (tu cuenta):</div>
  <div id="playersList" style="margin-top:8px"></div>
</div>

<!-- GENERATE TEAMS -->
<div class="box" id="generateBox" style="display:none;">
  <h2>Generar Equipos 7 vs 7</h2>
  <p class="small">Se respetan mínimos: 1 portero / equipo, 3 defensas / equipo, 1 delantero / equipo. Rellena con otros hasta 7.</p>
  <button id="btnGenerateTeams" class="primary" style="margin:10px 0;">Generar equipos balanceados</button>

  <div id="teamsResult" style="margin-top:15px;"></div>

  <div id="fieldBox" class="box" style="margin-top:20px; display:none;">
    <h2>Campo (alineación editable)</h2>
    <div style="display:flex; gap:20px; justify-content:center;">
      <div>
        <h3 style="text-align:center;">Negro</h3>
        <div id="fieldA" class="football-field"></div>
      </div>
      <div>
        <h3 style="text-align:center;">Blanco</h3>
        <div id="fieldB" class="football-field"></div>
      </div>
    </div>
  </div>

  <div id="selectedLineup" class="box" style="margin-top:20px; display:none;">
   <h2>Alineación seleccionada</h2>
   <div style="display:flex;gap:20px;">
     <div style="flex:1">
       <h3>Negro</h3>
       <ul id="selectedA"></ul>
     </div>
     <div style="flex:1">
       <h3>Blanco</h3>
       <ul id="selectedB"></ul>
     </div>
   </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const SUPABASE_URL = 'https://vayholflhqoyflbvuusa.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZheWhvbGZsaHFveWZsYnZ1dXNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzc5NjcsImV4cCI6MjA3ODY1Mzk2N30.QxD4_XbYlQarPRUcmoQQclw8cCnnzRiHZcYzSsUXGDA';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let localPlayers = [];
  let remotePlayers = [];
  let localIdCounter = 100000;

  const authMsg = document.getElementById('authMsg');
  const addPlayerBox = document.getElementById('addPlayerBox');
  const generateBox = document.getElementById('generateBox');
  const playersListEl = document.getElementById('playersList');
  const fieldA = document.getElementById("fieldA");
  const fieldB = document.getElementById("fieldB");

  document.getElementById('btnRegister').addEventListener('click', registerUser);
  document.getElementById('btnLogin').addEventListener('click', loginUser);
  document.getElementById('btnAddPlayer').addEventListener('click', onAddPlayerClicked);
  document.getElementById('btnGenerateTeams').addEventListener('click', onGenerateTeamsClicked);

  async function registerUser() {
    const email = document.getElementById('registerEmail').value.trim();
    const pass  = document.getElementById('registerPassword').value;
    if (!email || !pass) return alert('Introduce email y contraseña.');
    authMsg.textContent = 'Registrando...';
    const { data, error } = await supabase.auth.signUp({ email, password: pass });
    if (error) { authMsg.textContent = error.message; console.error(error); return; }
    authMsg.textContent = 'Registro enviado. Confirma tu email si es necesario.';
  }

  async function loginUser() {
    const email = document.getElementById('loginEmail').value.trim();
    const pass  = document.getElementById('loginPassword').value;
    if (!email || !pass) return alert('Introduce email y contraseña.');
    authMsg.textContent = 'Iniciando sesión...';
    const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
    if (error) { authMsg.textContent = error.message; console.error(error); return; }
    authMsg.textContent = 'Login correcto. Cargando datos...';
    await loadRemotePlayersAndShowUI();
  }

  async function getCurrentUser(){
    const res = await supabase.auth.getUser();
    return res?.data?.user || null;
  }

  async function loadRemotePlayersAndShowUI() {
    const user = await getCurrentUser();
    if (!user) { authMsg.textContent = 'No hay usuario'; return; }
    addPlayerBox.style.display = 'block';
    generateBox.style.display = 'block';
    document.getElementById('authBox').style.display = 'none';
    remotePlayers = await loadPlayersFromSupabase();
    renderPlayersList();
    authMsg.textContent = `Conectado como ${user.email}`;
  }

  async function loadPlayersFromSupabase(){
    const user = await getCurrentUser();
    if (!user) return [];
    const { data, error } = await supabase.from('players').select('*').eq('user_id', user.id).order('num_id', { ascending: true });
    if (error) { console.error(error); return []; }
    return data.map(row => ({ id: row.id, num_id: row.num_id, name: row.name, position: row.position, rating: row.rating }));
  }

  function renderPlayersList() {
    playersListEl.innerHTML = '';
    const list = [...remotePlayers, ...localPlayers];
    if (list.length === 0) {
      playersListEl.innerHTML = '<div class="small">No hay jugadores todavía.</div>';
      return;
    }
    const positionOrderMap = { portero: 0, defensa: 1, delantero: 2 };
    list.sort((a, b) => positionOrderMap[a.position] - positionOrderMap[b.position]);
    list.forEach(player => {
      const div = document.createElement('div');
      div.className = 'player-row';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.className = 'player-select';
      cb.dataset.playerId = player.num_id;
      const span = document.createElement('span');
      span.textContent = `${player.name} (${player.position}) - ${player.rating}`;
      div.appendChild(cb);
      div.appendChild(span);
      playersListEl.appendChild(div);
    });
  }

  async function onAddPlayerClicked() {
    const name = document.getElementById('playerName').value.trim();
    const position = document.getElementById('playerPosition').value;
    const rating = parseFloat(document.getElementById('playerSkill').value);
    if (!name || !position || isNaN(rating) || rating < 1 || rating > 10) {
        return alert("La media debe estar entre 1 y 10 (se permiten decimales).");
    }

    const user = await getCurrentUser();
    if (user) {
        const { data, error } = await supabase.from('players').insert([{ user_id: user.id, name, position, rating }]).select();
        if (error) { console.error(error); alert('Error guardando en la nube'); return; }
        remotePlayers.push({ id: data[0].id, name, position, rating });
        renderPlayersList();
        document.getElementById('playerName').value = '';
        document.getElementById('playerSkill').value = '';
        alert('Jugador guardado en Supabase.');
    } else {
        localIdCounter++;
        localPlayers.push({ id: localIdCounter, num_id: localIdCounter, name, position, rating });
        renderPlayersList();
        document.getElementById('playerName').value = '';
        document.getElementById('playerSkill').value = '';
        alert('Jugador añadido localmente (inicia sesión para guardarlo en la nube).');
    }
  }

  function generateBalancedTeams(players) {
    const teamSize = 7;
    const positions = { Portero: [], Defensa: [], Delantero: [] };
    players.forEach(p => {
      const pos = p.position.charAt(0).toUpperCase() + p.position.slice(1);
      if (positions[pos]) positions[pos].push(p);
    });
    if (positions.Portero.length < 2 || positions.Defensa.length < 6 || positions.Delantero.length < 2) return null;

    const teamA = [], teamB = [];
    function assignAlternating(arr) {
      arr.sort(() => Math.random() - 0.5);
      arr.forEach((player, i) => {
        if (teamA.length < teamSize && teamB.length < teamSize) {
          i % 2 === 0 ? teamA.push(player) : teamB.push(player);
        } else if (teamA.length < teamSize) teamA.push(player);
        else teamB.push(player);
      });
    }
    assignAlternating(positions.Portero);
    assignAlternating(positions.Defensa);
    assignAlternating(positions.Delantero);
    const allAssigned = [...teamA, ...teamB];
    const remaining = players.filter(p => !allAssigned.includes(p));
    assignAlternating(remaining);

    if (teamA.length !== 7 || teamB.length !== 7) return null;
    return { teamA, teamB };
  }

  function generateBalancedTeamsVariations(players, numVariations = 50) {
    const validTeams = [];
    for (let v = 0; v < numVariations; v++) {
        const teams = generateBalancedTeams(players);
        if (teams) {
            const avgA = teams.teamA.reduce((sum, p) => sum + p.rating, 0) / teams.teamA.length;
            const avgB = teams.teamB.reduce((sum, p) => sum + p.rating, 0) / teams.teamB.length;
            const diff = Math.abs(avgA - avgB);
            validTeams.push({ ...teams, diff });
        }
    }
    validTeams.sort((a, b) => a.diff - b.diff);
    return validTeams.slice(0, 5);
  }

  async function onGenerateTeamsClicked() {
    const checkboxes = Array.from(document.querySelectorAll('.player-select'));
    const allPlayers = [...localPlayers, ...remotePlayers];
    const selectedPlayers = checkboxes.filter(cb => cb.checked)
      .map(cb => allPlayers.find(p => p.num_id === parseInt(cb.dataset.playerId)))
      .filter(p => p !== undefined);
    if (selectedPlayers.length < 14) return alert('Debes seleccionar al menos 14 jugadores válidos.');

    const topTeams = generateBalancedTeamsVariations(selectedPlayers, 100);
    const teamsResultEl = document.getElementById('teamsResult');
    teamsResultEl.innerHTML = '';

    topTeams.forEach((t, index) => {
      const div = document.createElement('div');
      div.style.marginBottom = '20px';
      const h4 = document.createElement('h4');
      h4.textContent = `Opción ${index + 1} (diferencia de media: ${t.diff.toFixed(2)})`;
      div.appendChild(h4);

      const flex = document.createElement('div');
      flex.style.display = 'flex';
      flex.style.gap = '20px';

      const btnSelect = document.createElement('button');
      btnSelect.textContent = "Seleccionar esta opción";
      btnSelect.style.marginTop = "10px";
      btnSelect.addEventListener("click", () => {
          showSelectedLineup(t.teamA, t.teamB);
          placePlayersOnField(t.teamA, t.teamB);
      });
      div.appendChild(btnSelect);

      function createTeamList(team, title) {
           const container = document.createElement('div');
           container.style.flex = '1';
           const h3 = document.createElement('h5');
           h3.textContent = title;
           container.appendChild(h3);
           const ul = document.createElement('ul');
           team.forEach(p => { const li = document.createElement('li'); li.textContent = `${p.name} (${p.position})`; ul.appendChild(li); });
           container.appendChild(ul);
           const avg = (arr) => (arr.reduce((sum, p) => sum + p.rating, 0) / arr.length).toFixed(2);
           const avgDiv = document.createElement('div'); avgDiv.className = 'small'; avgDiv.textContent = `Media: ${avg(team)}`;
           container.appendChild(avgDiv);
           return container;
      }

      flex.appendChild(createTeamList(t.teamA, 'Negro'));
      flex.appendChild(createTeamList(t.teamB, 'Blanco'));
      div.appendChild(flex);
      teamsResultEl.appendChild(div);
    });
  }

  function showSelectedLineup(teamA, teamB) {
    const box = document.getElementById("selectedLineup");
    const ulA = document.getElementById("selectedA");
    const ulB = document.getElementById("selectedB");
    ulA.innerHTML = ""; ulB.innerHTML = "";
    teamA.forEach(p => { const li = document.createElement("li"); li.textContent = `${p.name} (${p.position})`; ulA.appendChild(li); });
    teamB.forEach(p => { const li = document.createElement("li"); li.textContent = `${p.name} (${p.position})`; ulB.appendChild(li); });
    box.style.display = "block";
  }

  function placePlayersOnField(teamA, teamB) {
    const fieldA = document.getElementById("fieldA");
    const fieldB = document.getElementById("fieldB");

    const basePositions = [
        { x: 140, y: 480 }, // Portero
        { x: 40,  y: 360 }, // Defensa izq
        { x: 140, y: 330 }, // Defensa centro
        { x: 240, y: 360 }, // Defensa der
        { x: 80,  y: 200 }, // Medio izq
        { x: 200, y: 200 }, // Medio der
        { x: 140, y: 80 }   // Delantero
    ];

// solo eliminar los jugadores
fieldA.querySelectorAll(".player-dot-wrapper")?.forEach(el => el.remove());
fieldB.querySelectorAll(".player-dot-wrapper")?.forEach(el => el.remove());


    function createPlayerEl(player, color, spot, container) {
        const wrapper = document.createElement("div");
        wrapper.className = "player-dot-wrapper";
        wrapper.style.position = "absolute";
        wrapper.style.left = spot.x + "px";
        wrapper.style.top = spot.y + "px";
        wrapper.style.textAlign = "center";
        wrapper.style.cursor = "grab";

        // Imagen de camiseta
        const img = document.createElement("img");
        img.src = color === "negra" ? "camiseta-negra.png" : "camiseta-blanca.png";
        img.style.width = "60px";
        img.style.height = "60px";
        wrapper.appendChild(img);

        // Nombre debajo
        const name = document.createElement("div");
        name.textContent = player.name;
        name.style.fontSize = "12px";
        name.style.marginTop = "4px";
        wrapper.appendChild(name);

        makeDraggableWithSnap(wrapper, container);
        container.appendChild(wrapper);
    }

    // TEAM A – Negro
    teamA.forEach((player, i) => {
        const spot = basePositions[i % basePositions.length];
        createPlayerEl(player, "negra", spot, fieldA);
    });

    // TEAM B – Blanco
    teamB.forEach((player, i) => {
        const spot = basePositions[i % basePositions.length];
        createPlayerEl(player, "blanca", spot, fieldB);
    });

    document.getElementById("fieldBox").style.display = "block";
}
  function setupFieldLines(field) {
  const topArea = document.createElement("div");
  topArea.className = "goal-area-top";
  field.appendChild(topArea);

  const bottomArea = document.createElement("div");
  bottomArea.className = "goal-area-bottom";
  field.appendChild(bottomArea);
}

// Llamadas para ambos campos
setupFieldLines(document.getElementById("fieldA"));
setupFieldLines(document.getElementById("fieldB"));


  function makeDraggableWithSnap(el, container) {
    let offsetX, offsetY;
    let isDragging = false;

    const snapSize = 40; // tamaño del snap (puedes ajustar)

    const startDrag = (clientX, clientY) => {
        const rect = el.getBoundingClientRect();
        offsetX = clientX - rect.left;
        offsetY = clientY - rect.top;
        isDragging = true;
        el.style.zIndex = 9999;
    };

    const drag = (clientX, clientY) => {
        if (!isDragging) return;
        const rect = container.getBoundingClientRect();
        let newX = clientX - rect.left - offsetX;
        let newY = clientY - rect.top - offsetY;

        // Limitar dentro del contenedor
        newX = Math.max(0, Math.min(newX, container.clientWidth - el.offsetWidth));
        newY = Math.max(0, Math.min(newY, container.clientHeight - el.offsetHeight));

        // Snap suave: redondear a la cuadrícula
        newX = Math.round(newX / snapSize) * snapSize;
        newY = Math.round(newY / snapSize) * snapSize;

        el.style.left = newX + "px";
        el.style.top = newY + "px";
    };

    const stopDrag = () => {
        isDragging = false;
    };

    // Eventos PC
    el.addEventListener("mousedown", e => { e.preventDefault(); startDrag(e.clientX, e.clientY); });
    document.addEventListener("mousemove", e => drag(e.clientX, e.clientY));
    document.addEventListener("mouseup", stopDrag);

    // Eventos Touch (móvil)
    el.addEventListener("touchstart", e => {
        e.preventDefault();
        const touch = e.touches[0];
        startDrag(touch.clientX, touch.clientY);
    }, { passive: false });

    document.addEventListener("touchmove", e => {
        const touch = e.touches[0];
        drag(touch.clientX, touch.clientY);
    }, { passive: false });

    document.addEventListener("touchend", stopDrag);
}


    function onMouseMove(e) {
      moveAt(e.clientX, e.clientY);
    }

    document.addEventListener("mousemove", onMouseMove);

    document.onmouseup = function() {
      document.removeEventListener("mousemove", onMouseMove);
      document.onmouseup = null;

      // Snap a cuadrícula SOLO AL SOLTAR
      const snapSize = 40;
      let left = parseInt(el.style.left);
      let top = parseInt(el.style.top);
      left = Math.round(left / snapSize) * snapSize;
      top = Math.round(top / snapSize) * snapSize;

      // Limitar nuevamente al contenedor
      left = Math.max(0, Math.min(left, container.clientWidth - el.offsetWidth));
      top = Math.max(0, Math.min(top, container.clientHeight - el.offsetHeight));

      el.style.left = left + "px";
      el.style.top = top + "px";
    };
  };

  el.ondragstart = () => false;
}


});
</script>
