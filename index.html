<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fútbol 7 Generator (Supabase)</title>

<style>
  body { font-family: Arial, Helvetica, sans-serif; padding: 20px; background: #f3f4f6; color:#0f1724; }
  h1 { margin-bottom: 6px; }
  .box { background: #fff; padding: 14px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  input, select, button { padding: 8px; margin:6px 4px 4px 0; border-radius:6px; border:1px solid #ddd; }
  button { cursor:pointer; background:#06b6d4; color:#fff; border:none; }
  button.secondary { background:#10b981; }
  ul { padding-left: 18px; }
  .small { font-size: 13px; color:#374151; }
  .player-row { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
  .player-row button { background:#ef4444; padding:6px 8px; }
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h1>Generador de Equipos Fútbol 7</h1>
<p class="small">Conexión Supabase integrada. Regístrate / inicia sesión y guarda tus jugadores en la nube.</p>

<!-- AUTH -->
<div class="box" id="authBox">
  <h2>Registro</h2>
  <input id="registerEmail" placeholder="Email">
  <input id="registerPassword" type="password" placeholder="Contraseña">
  <button id="btnRegister">Registrar</button>

  <hr>

  <h2>Login</h2>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="Contraseña">
  <button id="btnLogin">Login</button>

  <div id="authMsg" class="small" style="margin-top:8px;color:#6b7280"></div>
</div>

<!-- ADD PLAYER -->
<div class="box" id="addPlayerBox" style="display:none;">
  <h2>Añadir jugador</h2>
  <div class="player-row">
    <input id="playerName" placeholder="Nombre" style="flex:1">
    <select id="playerPosition">
      <option value="portero">Portero</option>
      <option value="defensa">Defensa</option>
      <option value="delantero">Delantero</option>
    </select>
    <input id="playerSkill" type="number" placeholder="Media (1-10)" min="1" max="10" step="0.1">
    <button id="btnAddPlayer" class="secondary">Agregar</button>
  </div>

  <div id="playersListTitle" class="small" style="margin-top:8px">Jugadores guardados (tu cuenta):</div>
  <div id="playersList" style="margin-top:8px"></div>
</div>

<!-- GENERATE TEAMS -->
<div class="box" id="generateBox" style="display:none;">
  <h2>Generar Equipos 7 vs 7</h2>
  <p class="small">Se respetan mínimos: 1 portero / equipo, 3 defensas / equipo, 1 delantero / equipo. Rellena con otros hasta 7.</p>
  <button id="btnGenerateTeams" class="primary" style="margin:10px 0;">Generar equipos balanceados</button>

  <div id="teamsResult" style="margin-top:15px"></div>

  <div style="display:flex;gap:20px;margin-top:12px">
    <div style="flex:1">
      <h3>Negro</h3>
      <ul id="teamA"></ul>
      <div id="avgA" class="small"></div>
    </div>
    <div style="flex:1">
      <h3>Blanco</h3>
      <ul id="teamB"></ul>
      <div id="avgB" class="small"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const SUPABASE_URL = 'https://vayholflhqoyflbvuusa.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZheWhvbGZsaHFveWZsYnZ1dXNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzc5NjcsImV4cCI6MjA3ODY1Mzk2N30.QxD4_XbYlQarPRUcmoQQclw8cCnnzRiHZcYzSsUXGDA';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let localPlayers = [];
  let remotePlayers = [];
  let localIdCounter = 100000;

  const authMsg = document.getElementById('authMsg');
  const addPlayerBox = document.getElementById('addPlayerBox');
  const generateBox = document.getElementById('generateBox');
  const playersListEl = document.getElementById('playersList');

  // --------------------------
  // Añadir jugador
  // --------------------------

async function onAddPlayerClicked() {
    const name = document.getElementById('playerName').value.trim();
    const position = document.getElementById('playerPosition').value;
    const rating = parseFloat(document.getElementById('playerSkill').value);

    if (!name || !position || isNaN(rating) || rating < 1 || rating > 10) {
        return alert("La media debe estar entre 1 y 10 (se permiten decimales).");
    }

    const user = await getCurrentUser();

    if (user) {
        // Guardamos en Supabase
        const { data, error } = await supabase
            .from('players')
            .insert([{ user_id: user.id, name, position, rating }])
            .select();
        if (error) { console.error(error); alert('Error guardando en la nube'); return; }

        remotePlayers.push({ id: data[0].id, name, position, rating });
        renderPlayersList();
        document.getElementById('playerName').value = '';
        document.getElementById('playerSkill').value = '';
        alert('Jugador guardado en Supabase.');
    } else {
        // Jugador local
        localIdCounter++;
        const localPlayer = { id: localIdCounter, name, position, rating };
        localPlayers.push(localPlayer);

        renderPlayersList();
        document.getElementById('playerName').value = '';
        document.getElementById('playerSkill').value = '';
        alert('Jugador añadido localmente (inicia sesión para guardarlo en la nube).');
    }
}

// ----------------------------
// Render de jugadores
// ----------------------------
function renderPlayersList() {
    playersListEl.innerHTML = '';

    const allPlayers = [...remotePlayers, ...localPlayers];

    if (allPlayers.length === 0) {
        playersListEl.innerHTML = '<div class="small">No hay jugadores todavía.</div>';
        return;
    }

    // Orden por posición
    const positionOrderMap = { portero: 0, defensa: 1, delantero: 2 };
    allPlayers.sort((a, b) => positionOrderMap[a.position] - positionOrderMap[b.position]);

    allPlayers.forEach(player => {
        const div = document.createElement('div');
        div.className = 'player-row';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'player-select';
        cb.dataset.playerId = player.id; // ✅ ID siempre definido

        const span = document.createElement('span');
        span.textContent = `${player.name} (${player.position}) - ${player.rating}`;

        div.appendChild(cb);
        div.appendChild(span);
        playersListEl.appendChild(div);
    });
}


  // --------------------------
  // Generar equipos balanceados
  // --------------------------
  function generateBalancedTeamsOptions(selectedPlayers, maxOptions = 5) {
    const teamSize = 7;
    const porteros = selectedPlayers.filter(p => p.position === 'portero');
    const defensas = selectedPlayers.filter(p => p.position === 'defensa');
    const delanteros = selectedPlayers.filter(p => p.position === 'delantero');

    if (porteros.length < 2 || defensas.length < 6 || delanteros.length < 2) {
        alert('No hay suficientes jugadores para generar equipos completos.');
        return [];
    }

    const options = [];

    for (let attempt = 0; attempt < 100; attempt++) { // 100 intentos max para encontrar combinaciones
        let teamA = [];
        let teamB = [];

        function assignRandom(arr) {
            const shuffled = arr.sort(() => Math.random() - 0.5);
            shuffled.forEach((player, i) => {
                if (i % 2 === 0) teamA.push(player);
                else teamB.push(player);
            });
        }

        assignRandom(porteros);
        assignRandom(defensas);
        assignRandom(delanteros);

        // Rellenar si queda menos de 7
        const leftovers = selectedPlayers.filter(p => !teamA.includes(p) && !teamB.includes(p));
        leftovers.forEach(player => {
            if (teamA.length < teamSize) teamA.push(player);
            else if (teamB.length < teamSize) teamB.push(player);
        });

        if (teamA.length === teamSize && teamB.length === teamSize) {
            const avg = arr => arr.reduce((sum,p)=>sum+p.rating,0)/arr.length;
            const diff = Math.abs(avg(teamA) - avg(teamB));
            if (diff <= 0.6) {
                // evitar duplicados
                const exists = options.some(opt => {
                    const aNames = opt.teamA.map(p=>p.name).sort().join(',');
                    const bNames = opt.teamB.map(p=>p.name).sort().join(',');
                    const newA = teamA.map(p=>p.name).sort().join(',');
                    const newB = teamB.map(p=>p.name).sort().join(',');
                    return (aNames===newA && bNames===newB) || (aNames===newB && bNames===newA);
                });
                if (!exists) options.push({ teamA, teamB });
            }
        }

        if (options.length >= maxOptions) break;
    }

    if (options.length === 0) alert('No se encontraron combinaciones balanceadas con diferencia ≤ 0.6.');
    return options;
}


 async function onGenerateTeamsClicked() {
    const checkboxes = Array.from(document.querySelectorAll('.player-select'));
    const selectedPlayers = checkboxes
        .filter(cb => cb.checked)
        .map(cb => {
            const id = parseInt(cb.dataset.playerId);
            return [...localPlayers, ...remotePlayers].find(p => p.id === id);
        })
        .filter(p => p !== undefined);

    if (selectedPlayers.length < 14) return alert('Debes seleccionar al menos 14 jugadores.');

    const teamOptions = generateBalancedTeamsOptions(selectedPlayers, 5);

    const teamsResultEl = document.getElementById('teamsResult');
    teamsResultEl.innerHTML = '';

    if (teamOptions.length === 0) return; // alerta ya en la función

    const avg = arr => (arr.reduce((sum,p)=>sum+p.rating,0)/arr.length).toFixed(2);

    teamOptions.forEach((opt, idx) => {
        const div = document.createElement('div');
        div.style.border = '1px solid #ccc';
        div.style.padding = '10px';
        div.style.marginBottom = '10px';
        div.style.borderRadius = '6px';
        div.style.background = '#f9f9f9';

        const title = document.createElement('h4');
        title.textContent = `Opción ${idx+1} - Dif media: ${(Math.abs(avg(opt.teamA)-avg(opt.teamB))).toFixed(2)}`;
        div.appendChild(title);

        const container = document.createElement('div');
        container.style.display = 'flex';
        container.style.gap = '20px';

        // Team A
        const teamADiv = document.createElement('div');
        const ulA = document.createElement('ul');
        opt.teamA.forEach(p => {
            const li = document.createElement('li');
            li.textContent = `${p.name} (${p.position}) - ${p.rating}`;
            ulA.appendChild(li);
        });
        const avgA = document.createElement('div');
        avgA.textContent = `Media: ${avg(opt.teamA)}`;
        avgA.className = 'small';
        teamADiv.appendChild(ulA);
        teamADiv.appendChild(avgA);

        // Team B
        const teamBDiv = document.createElement('div');
        const ulB = document.createElement('ul');
        opt.teamB.forEach(p => {
            const li = document.createElement('li');
            li.textContent = `${p.name} (${p.position}) - ${p.rating}`;
            ulB.appendChild(li);
        });
        const avgB = document.createElement('div');
        avgB.textContent = `Media: ${avg(opt.teamB)}`;
        avgB.className = 'small';
        teamBDiv.appendChild(ulB);
        teamBDiv.appendChild(avgB);

        container.appendChild(teamADiv);
        container.appendChild(teamBDiv);
        div.appendChild(container);

        // Botón para seleccionar esta opción
        const btnSelect = document.createElement('button');
        btnSelect.textContent = 'Seleccionar esta opción';
        btnSelect.style.marginTop = '8px';
        btnSelect.addEventListener('click', () => {
            document.getElementById('teamA').innerHTML = ulA.innerHTML;
            document.getElementById('teamB').innerHTML = ulB.innerHTML;
            document.getElementById('avgA').textContent = avgA.textContent;
            document.getElementById('avgB').textContent = avgB.textContent;
            teamsResultEl.innerHTML = `<div class="small">Opción ${idx+1} seleccionada</div>`; // limpiar opciones
        });
        div.appendChild(btnSelect);

        teamsResultEl.appendChild(div);
    });
}


  // --------------------------
  // Autenticación Supabase
  // --------------------------
  async function registerUser() {
    const email = document.getElementById('registerEmail').value.trim();
    const pass  = document.getElementById('registerPassword').value;
    if (!email || !pass) return alert('Introduce email y contraseña.');
    authMsg.textContent = 'Registrando...';
    const { data, error } = await supabase.auth.signUp({ email, password: pass });
    if (error) { authMsg.textContent = error.message; console.error(error); return; }
    authMsg.textContent = 'Registro enviado. Confirma tu email si es necesario.';
  }

  async function loginUser() {
    const email = document.getElementById('loginEmail').value.trim();
    const pass  = document.getElementById('loginPassword').value;
    if (!email || !pass) return alert('Introduce email y contraseña.');
    authMsg.textContent = 'Iniciando sesión...';
    const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
    if (error) { authMsg.textContent = error.message; console.error(error); return; }
    authMsg.textContent = 'Login correcto. Cargando datos...';
    await loadRemotePlayersAndShowUI();
  }

  async function getCurrentUser(){
    const res = await supabase.auth.getUser();
    return res?.data?.user || null;
  }

  async function loadRemotePlayersAndShowUI() {
    const user = await getCurrentUser();
    if (!user) { authMsg.textContent = 'No hay usuario'; return; }
    addPlayerBox.style.display = 'block';
    generateBox.style.display = 'block';
    document.getElementById('authBox').style.display = 'none';
    remotePlayers = await loadPlayersFromSupabase();
    renderPlayersList();
    authMsg.textContent = `Conectado como ${user.email}`;
  }

  async function loadPlayersFromSupabase(){
    const user = await getCurrentUser();
    if (!user) return [];
    const { data, error } = await supabase.from('players').select('*').eq('user_id', user.id).order('id', { ascending: true });
    if (error) { console.error(error); return []; }
    return data.map(row => ({ id: row.id, name: row.name, position: row.position, rating: row.rating }));
  }

  // --------------------------
  // LISTENERS
  // --------------------------
  document.getElementById('btnRegister').addEventListener('click', registerUser);
  document.getElementById('btnLogin').addEventListener('click', loginUser);
  document.getElementById('btnAddPlayer').addEventListener('click', onAddPlayerClicked);
  document.getElementById('btnGenerateTeams').addEventListener('click', onGenerateTeamsClicked);

  window._supabase = supabase;
  window._localPlayers = localPlayers;
  window._remotePlayers = remotePlayers;
});
</script>

</body>
</html>
