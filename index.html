<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>F√∫tbol 7 Pro - No Duplicados</title>

<style>
  :root { --primary: #06b6d4; --secondary: #10b981; --bg: #f3f4f6; --text: #1f2937; }
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: var(--bg); color: var(--text); max-width: 1000px; margin: 0 auto; }
  
  h1, h2, h3, h4 { margin-top: 0; color: #111827; }
  .box { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
  
  /* Inputs y Botones */
  input, select { padding: 10px; margin: 5px 0; border-radius: 6px; border: 1px solid #d1d5db; width: 100%; box-sizing: border-box; }
  .row-inputs { display: flex; gap: 10px; }
  
  button { padding: 10px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: opacity 0.2s; width: 100%; margin-top: 10px; }
  button:hover { opacity: 0.9; }
  button.primary { background: var(--primary); color: #fff; }
  button.secondary { background: var(--secondary); color: #fff; }
  button.outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

  /* Listas */
  .player-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
  .player-info { display: flex; align-items: center; gap: 10px; }
  .tag { padding: 2px 6px; border-radius: 4px; font-size: 11px; text-transform: uppercase; font-weight: bold; }
  .tag.portero { background: #fef3c7; color: #d97706; }
  .tag.defensa { background: #d1fae5; color: #059669; }
  .tag.delantero { background: #fee2e2; color: #dc2626; }

  /* Resultados de equipos */
  .option-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #fafafa; transition: transform 0.1s; }
  .option-card:hover { border-color: var(--primary); background: #fff; }
  .team-columns { display: flex; gap: 20px; margin-top: 10px; }
  .team-col { flex: 1; }
  .team-col ul { list-style: none; padding: 0; margin: 0; font-size: 0.9rem; }
  .team-col li { padding: 4px 0; border-bottom: 1px dashed #eee; display:flex; justify-content:space-between; }
  .pos-mini { font-size:0.75rem; color:#6b7280; margin-left:5px; }

  /* CAMPO DE F√öTBOL CSS */
  .field-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
  .football-field {
    position: relative;
    width: 350px; 
    height: 500px; 
    background-color: #4ca153;
    background-image: linear-gradient(0deg, transparent 24%, rgba(255,255,255,.3) 25%, rgba(255,255,255,.3) 26%, transparent 27%, transparent 74%, rgba(255,255,255,.3) 75%, rgba(255,255,255,.3) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(255,255,255,.3) 25%, rgba(255,255,255,.3) 26%, transparent 27%, transparent 74%, rgba(255,255,255,.3) 75%, rgba(255,255,255,.3) 76%, transparent 77%, transparent);
    background-size: 50px 50px;
    border: 5px solid #fff;
    border-radius: 8px;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
    overflow: hidden;
    user-select: none;
  }
  .field-line-center { position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: rgba(255,255,255,0.8); }
  .field-circle { position: absolute; top: 50%; left: 50%; width: 80px; height: 80px; border: 2px solid rgba(255,255,255,0.8); border-radius: 50%; transform: translate(-50%, -50%); }
  .area-top { position: absolute; top: 0; left: 50%; width: 160px; height: 80px; border: 2px solid rgba(255,255,255,0.8); border-top: none; transform: translateX(-50%); background: rgba(255,255,255,0.1); }
  .area-bottom { position: absolute; bottom: 0; left: 50%; width: 160px; height: 80px; border: 2px solid rgba(255,255,255,0.8); border-bottom: none; transform: translateX(-50%); background: rgba(255,255,255,0.1); }

  /* Fichas Jugadores */
  .player-token {
    position: absolute; width: 36px; height: 36px; border-radius: 50%; border: 2px solid #fff;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; font-weight: bold; cursor: grab; box-shadow: 0 2px 4px rgba(0,0,0,0.4); z-index: 10;
  }
  .player-token:active { cursor: grabbing; transform: scale(1.1); z-index: 20; }
  .token-black { background: #1f2937; color: white; }
  .token-white { background: #f9fafb; color: #1f2937; border-color: #1f2937; }
  .player-label {
    position: absolute; bottom: -16px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.7); color: #fff; padding: 1px 4px; border-radius: 3px;
    font-size: 9px; white-space: nowrap; pointer-events: none;
  }

  .hidden { display: none; }
  .small { font-size: 0.85rem; color: #6b7280; }
  .error-msg { color: #dc2626; font-size: 0.9rem; margin-top: 5px; font-weight: bold; }
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h1>‚öΩ Generador de Equipos F7</h1>

<div class="box" id="authBox">
  <h2>Acceso</h2>
  <div class="row-inputs">
    <input id="authEmail" placeholder="Email">
    <input id="authPassword" type="password" placeholder="Contrase√±a">
  </div>
  <div class="row-inputs">
    <button id="btnLogin" class="primary">Iniciar Sesi√≥n</button>
    <button id="btnRegister" class="secondary">Registrarse</button>
  </div>
  <div id="authMsg" class="small" style="margin-top:10px;"></div>
</div>

<div id="appContent" class="hidden">
  
  <div class="box">
    <h2>Gesti√≥n de Jugadores</h2>
    <div class="row-inputs">
      <input id="playerName" placeholder="Nombre" style="flex: 2;">
      <select id="playerPosition" style="flex: 1;">
        <option value="portero">Portero</option>
        <option value="defensa">Defensa</option>
        <option value="delantero">Delantero</option>
      </select>
      <input id="playerSkill" type="number" placeholder="Media" min="1" max="10" step="0.1" style="flex: 1;">
    </div>
    <button id="btnAddPlayer" class="secondary">Guardar Jugador</button>
    <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
    
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>Convocados <span id="playerCount" class="small"></span></h3>
        <button id="btnSelectAll" class="outline" style="width:auto; margin:0; padding:4px 10px; font-size:12px;">Seleccionar Todos</button>
    </div>
    <div id="playersList"></div>
  </div>

  <div class="box">
    <h2>Generar Opciones</h2>
    <p class="small">Requisitos: <strong>1 Portero, 3 Defensas, 1 Delantero</strong> (m√≠nimo). Se rellenan con sobrantes.</p>
    <button id="btnGenerateTeams" class="primary">üé≤ Generar 5 Opciones √önicas</button>
    <div id="generateError" class="error-msg"></div>

    <div id="teamsResult" style="margin-top:20px;"></div>
  </div>

  <div id="fieldSection" class="box hidden">
    <h2>Pizarra T√°ctica (Drag & Drop)</h2>
    <p class="small">Mueve las fichas para ajustar la posici√≥n.</p>
    <div class="field-container">
      <div>
        <h3 style="text-align:center;">Equipo Negro</h3>
        <div id="fieldA" class="football-field">
            <div class="field-line-center"></div><div class="field-circle"></div><div class="area-top"></div><div class="area-bottom"></div>
        </div>
      </div>
      <div>
        <h3 style="text-align:center;">Equipo Blanco</h3>
        <div id="fieldB" class="football-field">
            <div class="field-line-center"></div><div class="field-circle"></div><div class="area-top"></div><div class="area-bottom"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const SUPABASE_URL = 'https://vayholflhqoyflbvuusa.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZheWhvbGZsaHFveWZsYnZ1dXNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzc5NjcsImV4cCI6MjA3ODY1Mzk2N30.QxD4_XbYlQarPRUcmoQQclw8cCnnzRiHZcYzSsUXGDA';
  
  let supabase;
  try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch (e) { console.error(e); }

  let allPlayers = [];
  let currentUser = null;

  const authBox = document.getElementById('authBox');
  const appContent = document.getElementById('appContent');
  const authMsg = document.getElementById('authMsg');
  const playersListEl = document.getElementById('playersList');
  const fieldA = document.getElementById('fieldA');
  const fieldB = document.getElementById('fieldB');
  const generateError = document.getElementById('generateError');

  document.getElementById('btnRegister').addEventListener('click', () => handleAuth('signup'));
  document.getElementById('btnLogin').addEventListener('click', () => handleAuth('signin'));
  document.getElementById('btnAddPlayer').addEventListener('click', addPlayer);
  document.getElementById('btnGenerateTeams').addEventListener('click', generateTeamOptions);
  document.getElementById('btnSelectAll').addEventListener('click', () => {
    document.querySelectorAll('.p-select').forEach(c => c.checked = true);
  });

  async function handleAuth(type) {
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    if (!email || !password) return showMsg('Rellena email y contrase√±a');
    showMsg('Procesando...');
    let res = type === 'signup' ? await supabase.auth.signUp({ email, password }) : await supabase.auth.signInWithPassword({ email, password });
    if (res.error) showMsg('Error: ' + res.error.message);
    else { currentUser = res.data.user; showMsg('¬°√âxito!'); initApp(); }
  }
  function showMsg(txt) { authMsg.textContent = txt; }
  async function initApp() { authBox.style.display = 'none'; appContent.classList.remove('hidden'); await loadPlayers(); }

  async function loadPlayers() {
    if (!currentUser) return;
    const { data, error } = await supabase.from('players').select('*').eq('user_id', currentUser.id);
    allPlayers = data || [];
    renderList();
  }

  async function addPlayer() {
    const name = document.getElementById('playerName').value.trim();
    const position = document.getElementById('playerPosition').value;
    const rating = parseFloat(document.getElementById('playerSkill').value);
    if (!name || !rating) return alert('Datos incompletos');
    
    const newPlayer = { user_id: currentUser.id, name, position, rating, num_id: Date.now() };
    const { data, error } = await supabase.from('players').insert([newPlayer]).select();
    if (error) { alert('Error nube, usando local'); allPlayers.push(newPlayer); }
    else if(data && data.length) allPlayers.push(data[0]);
    
    document.getElementById('playerName').value = '';
    renderList();
  }

  function renderList() {
    playersListEl.innerHTML = '';
    document.getElementById('playerCount').textContent = `(${allPlayers.length})`;
    const order = { portero: 1, defensa: 2, delantero: 3 };
    [...allPlayers].sort((a,b) => order[a.position] - order[b.position]).forEach(p => {
      const div = document.createElement('div');
      div.className = 'player-row';
      div.innerHTML = `
        <div class="player-info">
          <input type="checkbox" class="p-select" checked value="${p.num_id || p.id}">
          <strong>${p.name}</strong> <span class="tag ${p.position}">${p.position}</span>
        </div>
        <span>${p.rating}</span>
      `;
      playersListEl.appendChild(div);
    });
  }

  // --- L√ìGICA DE GENERACI√ìN ---
  function generateTeamOptions() {
    generateError.textContent = '';
    const checks = document.querySelectorAll('.p-select:checked');
    const selectedIds = Array.from(checks).map(c => c.value);
    const pool = allPlayers.filter(p => selectedIds.includes(String(p.num_id)) || selectedIds.includes(String(p.id)));

    if (pool.length < 14) return generateError.textContent = 'Selecciona al menos 14 jugadores.';

    const countPos = (pos) => pool.filter(p => p.position === pos).length;
    const nGK = countPos('portero');
    const nDef = countPos('defensa');
    const nFwd = countPos('delantero');

    if (nGK < 2) return generateError.textContent = `Faltan porteros. Tienes ${nGK}, m√≠n 2.`;
    if (nDef < 6) return generateError.textContent = `Faltan defensas. Tienes ${nDef}, m√≠n 6.`;
    if (nFwd < 2) return generateError.textContent = `Faltan delanteros. Tienes ${nFwd}, m√≠n 2.`;

    let variations = [];
    const seenHashes = new Set(); // Para evitar duplicados

    // Aumentamos los intentos para asegurar encontrar 5 distintas
    for(let i=0; i<500; i++) { 
        const attempt = createStrictVariation(pool);
        if(!attempt) continue;

        // Crear Huella Digital √önica
        // 1. Obtener IDs ordenados de cada equipo
        const idsA = attempt.teamA.map(p => p.num_id || p.id).sort().join('-');
        const idsB = attempt.teamB.map(p => p.num_id || p.id).sort().join('-');
        
        // 2. Ordenar los dos equipos para que A vs B sea igual a B vs A
        const matchHash = [idsA, idsB].sort().join('::');

        if(seenHashes.has(matchHash)) {
            continue; // Si ya existe esta combinaci√≥n exacta, saltar
        }

        seenHashes.add(matchHash);
        variations.push(attempt);
    }

    variations.sort((a, b) => a.diff - b.diff);
    const top5 = variations.slice(0, 5);
    
    if (top5.length === 0) return generateError.textContent = "No se encontraron combinaciones v√°lidas.";
    
    displayOptions(top5);
  }

  function createStrictVariation(originalPool) {
    const gks = originalPool.filter(p => p.position === 'portero');
    const defs = originalPool.filter(p => p.position === 'defensa');
    const fwds = originalPool.filter(p => p.position === 'delantero');

    const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);

    const s_gks = shuffle(gks);
    const s_defs = shuffle(defs);
    const s_fwds = shuffle(fwds);

    const teamA = [];
    const teamB = [];

    // FASE 1: OBLIGATORIOS
    teamA.push(s_gks.pop()); teamB.push(s_gks.pop());
    for(let k=0; k<3; k++) teamA.push(s_defs.pop());
    for(let k=0; k<3; k++) teamB.push(s_defs.pop());
    teamA.push(s_fwds.pop()); teamB.push(s_fwds.pop());

    // FASE 2: RELLENO
    const leftovers = [...s_gks, ...s_defs, ...s_fwds];
    const s_leftovers = shuffle(leftovers);
    
    while(teamA.length < 7 && s_leftovers.length > 0) teamA.push(s_leftovers.pop());
    while(teamB.length < 7 && s_leftovers.length > 0) teamB.push(s_leftovers.pop());

    const getSum = t => t.reduce((acc, c) => acc + c.rating, 0);
    const avgA = getSum(teamA) / teamA.length;
    const avgB = getSum(teamB) / teamB.length;

    return {
        teamA, teamB,
        avgA: avgA.toFixed(2), avgB: avgB.toFixed(2),
        diff: Math.abs(avgA - avgB)
    };
  }

  function displayOptions(options) {
    const container = document.getElementById('teamsResult');
    container.innerHTML = '';

    options.forEach((opt, index) => {
        const div = document.createElement('div');
        div.className = 'option-card';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 style="margin:0">Opci√≥n ${index + 1}</h4>
                <span class="tag" style="background:#e0e7ff; color:#4338ca;">Dif: ${opt.diff.toFixed(2)}</span>
            </div>
            <div class="team-columns">
                <div class="team-col">
                    <strong>Negro (${opt.avgA})</strong>
                    <ul>${renderTeamList(opt.teamA)}</ul>
                </div>
                <div class="team-col">
                    <strong>Blanco (${opt.avgB})</strong>
                    <ul>${renderTeamList(opt.teamB)}</ul>
                </div>
            </div>
            <button class="outline select-opt-btn" style="margin-top:10px;">Ver en campo</button>
        `;
        div.querySelector('.select-opt-btn').addEventListener('click', () => {
            document.getElementById('fieldSection').classList.remove('hidden');
            drawField(opt.teamA, opt.teamB);
            document.getElementById('fieldSection').scrollIntoView({behavior: "smooth"});
        });
        container.appendChild(div);
    });
  }

  function renderTeamList(team) {
    const order = { portero:0, defensa:1, delantero:2 };
    const sorted = [...team].sort((a,b) => order[a.position] - order[b.position]);
    return sorted.map(p => `<li><span>${p.name}</span><span class="pos-mini">${p.position.substring(0,3)}</span></li>`).join('');
  }

  // --- VISUALIZACI√ìN ---
  function drawField(teamA, teamB) {
    cleanTokens(fieldA); cleanTokens(fieldB);
    
    // Coordenadas fijas para la estructura 1-3-1 + 2 libres
    const posCoords = {
        portero: [{x:155, y:450}],
        defensa: [{x:50, y:350}, {x:155, y:350}, {x:260, y:350}, {x:80, y:300}, {x:230, y:300}], 
        delantero: [{x:155, y:100}, {x:100, y:150}, {x:210, y:150}] 
    };

    const place = (team, div, color) => {
      const currentCoords = JSON.parse(JSON.stringify(posCoords));
      team.forEach(p => {
        let spot;
        if (currentCoords[p.position] && currentCoords[p.position].length > 0) {
            spot = currentCoords[p.position].shift();
        } else {
            spot = {x: 155 + (Math.random()*40 - 20), y: 220 + (Math.random()*40 - 20)};
        }
        createToken(p, div, color, spot.x, spot.y);
      });
    }
    place(teamA, fieldA, 'token-black');
    place(teamB, fieldB, 'token-white');
  }

  function cleanTokens(div) { div.querySelectorAll('.player-token').forEach(e => e.remove()); }
  function createToken(p, div, cls, x, y) {
    const el = document.createElement('div');
    el.className = `player-token ${cls}`;
    el.textContent = p.name.substring(0,2).toUpperCase();
    el.style.left = x+'px'; el.style.top = y+'px';
    const l = document.createElement('div'); l.className='player-label'; l.textContent=p.name;
    el.appendChild(l);
    
    el.onmousedown = dragMouse;
    el.ontouchstart = dragTouch;
    div.appendChild(el);
  }

  let active = null, startX, startY, initX, initY;
  function dragMouse(e) { 
    e.preventDefault(); active=e.currentTarget; startX=e.clientX; startY=e.clientY; initX=active.offsetLeft; initY=active.offsetTop;
    document.onmousemove=e=>{ if(!active)return; active.style.left=(initX+e.clientX-startX)+'px'; active.style.top=(initY+e.clientY-startY)+'px'; };
    document.onmouseup=()=>{ active=null; document.onmousemove=null; };
  }
  function dragTouch(e) {
    active=e.currentTarget; const t=e.touches[0]; startX=t.clientX; startY=t.clientY; initX=active.offsetLeft; initY=active.offsetTop;
    document.ontouchmove=e=>{ if(!active)return; const t=e.touches[0]; active.style.left=(initX+t.clientX-startX)+'px'; active.style.top=(initY+t.clientY-startY)+'px'; };
    document.ontouchend=()=>{ active=null; document.ontouchmove=null; };
  }

});
</script>
</body>
</html>
