<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Fútbol 7 Generator</title>
<style>
  body { font-family: Arial; padding: 20px; background: #eee; }
  input, select { padding: 6px; margin: 4px; }
  .box { background: white; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
</style>
</head>

<body>

<h1>Generador de Equipos Fútbol 7</h1>

<!-- LOGIN / REGISTER -->
<div class="box">
  <h2>Registro</h2>
  <input id="registerEmail" placeholder="Email"><br>
  <input id="registerPassword" type="password" placeholder="Contraseña"><br>
  <button onclick="registerUser()">Registrar</button>

  <hr>

  <h2>Login</h2>
  <input id="loginEmail" placeholder="Email"><br>
  <input id="loginPassword" type="password" placeholder="Contraseña"><br>
  <button onclick="loginUser()">Login</button>
</div>

<!-- ADD PLAYERS -->
<div class="box">
  <h2>Añadir jugador</h2>
  <input id="playerName" placeholder="Nombre">
  <select id="playerPosition">
    <option value="portero">Portero</option>
    <option value="defensa">Defensa</option>
    <option value="medio">Medio</option>
    <option value="delantero">Delantero</option>
  </select>
  <input id="playerSkill" type="number" placeholder="Media (1-100)">
  <button onclick="addPlayer()">Agregar</button>
</div>

<!-- GENERATE TEAMS -->
<div class="box">
  <h2>Generar Equipos</h2>
  <button onclick="generateTeams()">Generar 2 Equipos Balanceados</button>

  <h3>Equipo A</h3>
  <ul id="teamA"></ul>

  <h3>Equipo B</h3>
  <ul id="teamB"></ul>
</div>


<!-- SUPABASE + APP LOGIC -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

window.onload = function() {

  // -------------------------
  // 1. INICIALIZAR SUPABASE
  // -------------------------
  const supabaseUrl = "https://vayholflhqoyflbvuusa.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZheWhvbGZsaHFveWZsYnZ1dXNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzc5NjcsImV4cCI6MjA3ODY1Mzk2N30.QxD4_XbYlQarPRUcmoQQclw8cCnnzRiHZcYzSsUXGDA";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  // Memoria local de jugadores del usuario
  let players = [];


  // -------------------------
  // 2. REGISTRO
  // -------------------------
  async function registerUser() {
    const email = document.getElementById("registerEmail").value;
    const password = document.getElementById("registerPassword").value;

    const { error } = await supabase.auth.signUp({ email, password });

    if (error) return alert(error.message);
    alert("Usuario registrado.");
  }


  // -------------------------
  // 3. LOGIN
  // -------------------------
  async function loginUser() {
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;

    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password
    });

    if (error) return alert(error.message);

    alert("Login correcto.");
  }

// ===============================
// GUARDAR JUGADOR
// ===============================
async function savePlayer(name, position, rating) {
    const user = await supabase.auth.getUser();
    if (!user.data.user) {
        alert("Debes iniciar sesión.");
        return;
    }

    const { data, error } = await supabase
        .from("players")
        .insert({
            user_id: user.data.user.id,
            name,
            position,
            rating
        });

    if (error) {
        console.error(error);
        alert("Error guardando jugador.");
    } else {
        alert("Jugador guardado correctamente.");
    }
}
// ===============================
// CARGAR JUGADORES DEL USUARIO
// ===============================
async function loadPlayers() {
    const user = await supabase.auth.getUser();
    if (!user.data.user) return [];

    const { data, error } = await supabase
        .from("players")
        .select("*")
        .eq("user_id", user.data.user.id);

    if (error) {
        console.error(error);
        return [];
    }

    return data;
}
// ===============================
// GENERAR EQUIPOS BALANCEADOS FUT7
// ===============================
async function generateBalancedTeams() {
    const players = await loadPlayers();

    if (players.length < 14) {
        alert("Necesitas mínimo 14 jugadores (7 por equipo).");
        return;
    }

    // Clasificar por posición
    const POR = players.filter(p => p.position === "POR");
    const DEF = players.filter(p => p.position === "DEF");
    const DEL = players.filter(p => p.position === "DEL");
    const MED = players.filter(p => p.position === "MED");

    if (POR.length < 2) return alert("Se necesitan 2 porteros.");
    if (DEF.length < 6) return alert("Se necesitan mínimo 6 defensas.");
    if (DEL.length < 2) return alert("Se necesitan mínimo 2 delanteros.");

    let teamA = [];
    let teamB = [];

    // 1 portero por equipo
    teamA.push(POR.pop());
    teamB.push(POR.pop());

    // 3 defensas por equipo
    for (let i = 0; i < 3; i++) {
        teamA.push(DEF.pop());
        teamB.push(DEF.pop());
    }

    // 1 delantero por equipo
    teamA.push(DEL.pop());
    teamB.push(DEL.pop());

    // Resto → rellenar hasta 7 jugadores
    let remaining = [...POR, ...DEF, ...DEL, ...MED];

    while (teamA.length < 7) teamA.push(remaining.pop());
    while (teamB.length < 7) teamB.push(remaining.pop());

    // Ordenar por media
    const avgA = teamA.reduce((a,b) => a + b.rating, 0) / 7;
    const avgB = teamB.reduce((a,b) => a + b.rating, 0) / 7;

    console.log("MEDIA A:", avgA);
    console.log("MEDIA B:", avgB);

    // guardar en Supabase
    await saveTeams(teamA, teamB);

    alert("Equipos generados y guardados.");

    return { teamA, teamB };
}
// ===============================
// GUARDAR EQUIPOS GENERADOS
// ===============================
async function saveTeams(teamA, teamB) {
    const user = await supabase.auth.getUser();
    if (!user.data.user) return;

    await supabase
        .from("teams")
        .insert({
            user_id: user.data.user.id,
            team_a: teamA,
            team_b: teamB
        });
}

  // -------------------------
  // 4. AÑADIR JUGADOR
  // -------------------------
  window.addPlayer = function () {
    const name = document.getElementById("playerName").value;
    const position = document.getElementById("playerPosition").value;
    const skill = parseInt(document.getElementById("playerSkill").value);

    if (!name || !position || !skill)
      return alert("Completa todos los campos");

    players.push({ name, position, skill });

    alert(`Jugador ${name} agregado`);
  };


  // -------------------------
  // 5. GENERAR EQUIPOS 7vs7
  // -------------------------
  window.generateTeams = function () {

    if (players.length < 14)
      return alert("Necesitas al menos 14 jugadores para 2 equipos de 7.");

    // Ordenar por media (mayor primero)
    let sorted = [...players].sort((a,b) => b.skill - a.skill);

    let teamA = [];
    let teamB = [];

    // Seleccionar posiciones críticas
    function pickPosition(pos, totalNeeded) {

      const pool = sorted.filter(p => p.position === pos);

      if (pool.length < totalNeeded)
        return alert(`Faltan jugadores en posición ${pos}`);

      for (let i = 0; i < totalNeeded; i++) {
        if (i % 2 === 0) teamA.push(pool[i]);
        else teamB.push(pool[i]);
      }

      sorted = sorted.filter(p => !pool.includes(p));
    }

    // Requisitos Fútbol 7
    pickPosition("portero", 2);
    pickPosition("defensa", 6);
    pickPosition("delantero", 2);

    // Rellenar con medios o sobrantes
    for (let p of sorted) {
      if (teamA.length < 7) teamA.push(p);
      else if (teamB.length < 7) teamB.push(p);
    }

    // Mostrar equipos
    const ulA = document.getElementById("teamA");
    const ulB = document.getElementById("teamB");
    ulA.innerHTML = "";
    ulB.innerHTML = "";

    teamA.forEach(p => {
      let li = document.createElement("li");
      li.textContent = `${p.name} (${p.position}, ${p.skill})`;
      ulA.appendChild(li);
    });

    teamB.forEach(p => {
      let li = document.createElement("li");
      li.textContent = `${p.name} (${p.position}, ${p.skill})`;
      ulB.appendChild(li);
    });

  };


  // Hacer accesibles funciones de auth
  window.registerUser = registerUser;
  window.loginUser = loginUser;

}; // FIN window.onload

</script>

</body>
</html>
