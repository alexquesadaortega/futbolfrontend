<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generador de Equipos</title>

  <!-- ICONO Y COLOR DE LA WEBB APP -->
<link rel="icon" href="icono.png" type="image/png">
<link rel="apple-touch-icon" href="icono.png">
<meta name="theme-color" content="#0f1724">

<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

body {
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(180deg, #0f1724 0%, #1a2238 100%);
  color: #e6eef6;
  padding: 10px;
  text-align: center;
  margin: 0;
  min-height: 100vh;
  animation: fadeIn 0.8s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

h1 {
  margin-bottom: 10px;
  font-weight: 600;
  color: #0ff0fc;
  letter-spacing: 0.5px;
  text-shadow: 0 0 8px rgba(0, 255, 255, 0.4);
  animation: slideDown 0.8s ease;
}

@keyframes slideDown {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.card {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(8px);
  padding: 14px;
  border-radius: 12px;
  margin: 10px auto;
  width: 95%;
  max-width: 600px;
  text-align: left;
  box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
  animation: fadeIn 1s ease;
}

.players-list {
  list-style: none;
  padding: 0;
  max-height: 200px;
  overflow: auto;
}

.players-list li {
  padding: 6px;
  margin: 3px 0;
  background: rgba(255, 255, 255, 0.08);
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  transition: background 0.2s, transform 0.2s;
  animation: fadeInUp 0.4s ease both;
}

.players-list li:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: translateX(4px);
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}

button {
  background: linear-gradient(135deg, #06b6d4, #0ea5e9);
  color: #fff;
  cursor: pointer;
  margin: 6px;
  padding: 8px 14px;
  border-radius: 8px;
  border: none;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.2s ease;
  animation: fadeIn 0.8s ease;
}

button:hover {
  transform: scale(1.05);
  box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
}

button:active {
  transform: scale(0.96);
}

#proposalsContainer {
  margin-top: 12px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 14px;
}

.proposal {
  padding: 10px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  gap: 6px;
  transition: transform 0.2s, background 0.2s;
  animation: fadeInUp 0.6s ease both;
}

.proposal:hover {
  transform: translateY(-4px);
  background: rgba(255, 255, 255, 0.1);
}

.team-box {
  background: rgba(255, 255, 255, 0.03);
  padding: 6px;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.team-title {
  font-weight: 600;
  margin-bottom: 4px;
  color: #06b6d4;
}

.player-entry {
  display: flex;
  justify-content: space-between;
  background: rgba(255, 255, 255, 0.08);
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 13px;
}

#fieldsContainer {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 25px;
  flex-wrap: wrap;
  animation: fadeIn 1s ease;
}

.field {
  position: relative;
  width: 320px;
  height: 480px;
  background: #0f4720; /* fondo s√≥lido en lugar de gradient */
  border: 2px solid #fff;
  border-radius: 10px;
  display: none;
  box-shadow: 0 0 20px rgba(0, 255, 100, 0.15);
  overflow: hidden;
}

.field-title {
  position: absolute;
  top: 6px;
  width: 100%;
  text-align: center;
  font-weight: 600;
  color: #fff;
  font-size: 13px;
  letter-spacing: 0.5px;
  text-shadow: 0 0 6px rgba(0, 0, 0, 0.5);
}

.player-card {
  position: absolute;
  width: 45px;
  height: 50px;
  text-align: center;
  font-weight: 600;
  color: #fff;
  cursor: grab;
  transition: transform 0.2s ease;
  animation: fadeInUp 0.3s ease both;
  background: #000; /* fondo s√≥lido para html2canvas */
  border-radius: 5px;
  overflow: hidden;
}

.player-card:hover {
  transform: scale(1.08);
}

.player-card img {
  width: 100%;
  height: 100%;
  display: block;
  background: #000; /* fondo s√≥lido detr√°s de la imagen */
}

.player-card span {
  display: block;
  font-size: 10px;
  margin-top: 2px;
  word-wrap: break-word;
  background: #000; /* fondo s√≥lido detr√°s del nombre */
  color: #fff;
  padding: 1px 2px;
  border-radius: 2px;
}

.export-btn {
  margin-top: 8px;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  animation-delay: 0.4s;
}

.export-btn:hover {
  box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
}

.login-card, #registerCard {
  max-width: 300px;
  margin: 20px auto;
  padding: 20px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
  text-align: center;
  box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
}

.login-input, #registerCard input {
  width: 90%;
  margin: 6px 0;
  padding: 8px;
  border-radius: 8px;
  border: none;
  background: rgba(255, 255, 255, 0.1);
  color: #e6eef6;
  font-size: 14px;
}

.login-input::placeholder, #registerCard input::placeholder {
  color: #b8c2cc;
}
@media (display-mode: standalone) {
  body {
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
    overflow: hidden;
  }

  h1 {
    margin-top: 20px;
    font-size: 22px;
  }

  .card {
    width: 90%;
    margin-top: 10px;
  }

  button {
    font-size: 16px;
    padding: 12px 18px;
    border-radius: 10px;
  }

  #fieldsContainer {
    transform: scale(0.9);
  }
}
/* --- Mejora de nitidez en exportaci√≥n --- */
.player-card, 
.player-card img, 
.player-card span {
  opacity: 1 !important;
  filter: none !important;
  transform: none !important;
  mix-blend-mode: normal !important;
  will-change: auto !important;
  isolation: isolate !important;
  background: transparent !important;
}
#field1, #field2 {
  background-color: #0f4720 !important;
  opacity: 1 !important;
  mix-blend-mode: normal !important;
  transform: none !important;
  will-change: auto !important;
  isolation: isolate !important;
}
/* --- Campo de f√∫tbol --- */
.field {
  position: relative;
  width: 320px;
  height: 480px;
  background-color: #0f4720;
  border: 2px solid white;
  border-radius: 8px;
  overflow: hidden;
}
.player {
  position: absolute;
  text-align: center;
  color: white;
  font-size: 12px;
  user-select: none;
}

.shirt {
  border-radius: 50%;
  width: 28px;
  height: 28px;
  line-height: 28px;
  font-weight: bold;
  margin: auto;
  box-shadow: 0 0 4px rgba(0,0,0,0.4);
}

.shirt.black {
  background: black;
  color: white;
}

.shirt.white {
  background: white;
  color: black;
}

.player-name {
  font-size: 10px;
  color: white;
  text-shadow: 0 0 3px black;
}

</style>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f1724">
</head>
<body>

<h1>GENERADOR DE EQUIPOS Y ALINEACIONES</h1>

<!-- LOGIN -->
<div class="login-card" id="loginCard">
  <strong>Identif√≠cate</strong><br>
  <input type="text" id="loginUser" placeholder="Usuario" class="login-input"><br>
  <input type="password" id="loginPass" placeholder="Contrase√±a" class="login-input"><br>
  <button id="loginBtn">Entrar</button>
  <div id="loginMsg" style="color:red;margin-top:6px;"></div>
</div>

<!-- REGISTRO -->
<div id="registerCard">
  <strong>Reg√≠strate</strong><br>
  <input type="text" id="regUser" placeholder="Usuario"><br>
  <input type="password" id="regPass" placeholder="Contrase√±a"><br>
  <button id="registerBtn">Registrar</button>
  <div id="regMsg" style="color:red;margin-top:6px;"></div>
</div>

<!-- JUGADORES -->
<div class="card" id="playersCard" style="display:none;">
  <strong>Selecciona los jugadores que van a jugar (m√°x. 14):</strong>
  <ul id="playersContainer" class="players-list"></ul>
  <button id="generate">Generar hasta 5 combinaciones</button>
  <button id="generateOptimized">Optimizar equilibrio</button>
</div>

<div class="card" id="addPlayerCard" style="display:none;">
  <strong>Agregar jugador:</strong><br>
  <input type="text" id="newName" placeholder="Nombre" class="login-input"><br>
  <select id="newPos" class="login-input">
    <option value="Portero">Portero</option>
    <option value="Defensa">Defensa</option>
    <option value="Delantero">Delantero</option>
  </select><br>
  <input type="number" id="newMedia" placeholder="Media (0-10)" class="login-input" min="0" max="10"><br>
  <button id="addPlayerBtn">Agregar jugador</button>
</div>

<!-- PROPUESTAS -->
<div class="card" id="proposalsCard" style="display:none;">
  <strong>Propuestas generadas (haz click en la que prefieras):</strong>
  <div id="proposalsContainer"></div>
</div>

<!-- CAMPOS -->
<div id="fieldsContainer">
  <div>
    <div id="field1" class="field"><div class="field-title">Equipo Negro</div></div>
    <button class="export-btn" onclick="exportField('field1')">Exportar Equipo Negro</button>
  </div>
  <div>
    <div id="field2" class="field"><div class="field-title">Equipo Blanco</div></div>
    <button class="export-btn" onclick="exportField('field2')">Exportar Equipo Blanco</button>
  </div>
</div>

<!-- NUEVO BOT√ìN GLOBAL -->
<div style="text-align:center; margin-top:20px;">
  <button id="exportarAmbosBtn" class="export-btn">üì∏ Exportar Ambos Equipos</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
const API_URL = 'https://futbol-backend-0gnv.onrender.com';
const positionOrder = { Portero: 0, Defensa: 1, Delantero: 2, Mediocentro: 3 };
const shirtImages = {
  black: "camiseta-negra.png",
  white: "camiseta-blanca.png"
};

// ---------------- LOGIN ----------------
document.getElementById('loginBtn').addEventListener('click', async () => {
  const username = document.getElementById('loginUser').value.trim();
  const password = document.getElementById('loginPass').value.trim();
  const loginMsg = document.getElementById('loginMsg'); 
  loginMsg.textContent = '';

  if (!username || !password) {
    loginMsg.textContent = 'Introduce usuario y contrase√±a';
    return;
  }

  try {
    // Hacer login
    const res = await fetch(`${API_URL}/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();

    if (!data.success) {
      loginMsg.textContent = data.message;
      return;
    }

    // Login correcto
    currentUser = { username };

    // Obtener jugadores de manera segura
    let dataPlayers = { players: [] };
    try {
      const resPlayers = await fetch(`${API_URL}/get-players`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username })
      });
      const playersResp = await resPlayers.json();
      dataPlayers.players = Array.isArray(playersResp.players) ? playersResp.players : [];
    } catch (err) {
      console.warn('No se pudieron cargar los jugadores, se inicializa vac√≠o', err);
      dataPlayers.players = [];
    }

    currentPlayers = dataPlayers.players;

    // Mostrar interfaz
    document.getElementById('loginCard').style.display = 'none';
    document.getElementById('registerCard').style.display = 'none';
    document.getElementById('playersCard').style.display = 'block';
    document.getElementById('addPlayerCard').style.display = 'block';

    renderPlayerList();

  } catch (err) {
    console.error(err);
    loginMsg.textContent = 'Error de conexi√≥n';
  }
});


// ---------------- REGISTRO ----------------
document.getElementById('registerBtn').addEventListener('click', async ()=>{
  const username = document.getElementById('regUser').value.trim();
  const password = document.getElementById('regPass').value.trim();
  const regMsg = document.getElementById('regMsg');
  regMsg.textContent = '';

  if(!username || !password){ regMsg.textContent='Introduce usuario y contrase√±a'; return; }

  try{
    const res = await fetch(`${API_URL}/register`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({username,password})
    });
    const data = await res.json();
    regMsg.textContent = data.message;
    if(data.success){
      document.getElementById('regUser').value='';
      document.getElementById('regPass').value='';
    }
  }catch(err){ console.error(err); regMsg.textContent='Error de conexi√≥n'; }
});

// ---------------- LISTA DE JUGADORES ----------------
function renderPlayerList() {
  // Creamos una lista que contiene { player, origIndex }, y la ordenamos por posici√≥n
  const mapped = currentPlayers.map((p, idx) => ({ p, idx }));
  mapped.sort((a, b) => positionOrder[a.p.pos] - positionOrder[b.p.pos]);

  const container = document.getElementById('playersContainer');
  container.innerHTML = '';

  mapped.forEach(({ p, idx }) => {
    const li = document.createElement('li');

    // Mostramos el jugador con su checkbox y bot√≥n de eliminar
    li.innerHTML = `
      <label>
        <input type="checkbox" data-index="${idx}">
        ${p.name} (${p.pos}) [${p.media}]
      </label>
      <button class="delete-btn" data-index="${idx}" style="margin-left:8px; background-color:#e74c3c; color:white; border:none; border-radius:5px; padding:4px 8px; cursor:pointer;">
        Eliminar
      </button>
    `;

    container.appendChild(li);
  });

  // Limitar selecci√≥n a m√°ximo 14 jugadores
  const checkboxes = container.querySelectorAll('input[type="checkbox"]');
  checkboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      const checked = container.querySelectorAll('input[type="checkbox"]:checked');
      if (checked.length > 14) {
        cb.checked = false;
        alert('No se pueden seleccionar m√°s de 14 jugadores');
      }
    });
  });

  // --- ELIMINAR JUGADORES ---
  const deleteButtons = container.querySelectorAll('.delete-btn');
  deleteButtons.forEach(btn => {
    btn.addEventListener('click', async () => {
      const idx = Number(btn.dataset.index);
      const player = currentPlayers[idx];

      if (!confirm(`¬øSeguro que quieres eliminar a ${player.name}?`)) return;

      try {
        const res = await fetch(`${API_URL}/delete-player`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: currentUser.username,
            playerName: player.name
          })
        });

        const data = await res.json();
        if (!data.success) {
          alert(data.message || 'Error al eliminar jugador');
          return;
        }

        // Eliminar jugador del array local y volver a renderizar
        currentPlayers.splice(idx, 1);
        renderPlayerList();

      } catch (err) {
        console.error('Error al eliminar jugador:', err);
        alert('Error de conexi√≥n al eliminar jugador');
      }
    });
  });
}

// ---------------- AGREGAR JUGADOR ----------------
document.getElementById('addPlayerBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('newName').value.trim();
  const pos = document.getElementById('newPos').value;
  const media = parseFloat(document.getElementById('newMedia').value);
  if(!name || isNaN(media) || media<0 || media>10){ alert('Datos incorrectos'); return; }

  const newPlayer = {name,pos,media};

  try{
    const res = await fetch(`${API_URL}/add-player`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({username:currentUser.username, player:newPlayer})
    });
    const data = await res.json();
    if(!data.success){ alert(data.message); return; }
    currentPlayers.push(newPlayer);
    renderPlayerList();
    document.getElementById('newName').value='';
    document.getElementById('newMedia').value='';
  }catch(err){ console.error(err); alert('Error al guardar jugador'); }
});
// ---------------- EQUIPOS ----------------
let teamAlertShown = false; // üîπ Evita que se repita el alert

function shuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function averageMedia(team) {
  return team.reduce((a, b) => a + b.media, 0) / team.length;
}

function generateTeams(players, numTeams = 2) {
  const maxPlayers = 7;

  // Agrupar jugadores por posici√≥n
  const posGroups = { Portero: [], Defensa: [], Delantero: [], Otros: [] };
  players.forEach(p => {
    if (posGroups[p.pos]) posGroups[p.pos].push(p);
    else posGroups.Otros.push(p);
  });

  // Validar m√≠nimos para formar equipos
  if (
    posGroups.Portero.length < 2 ||
    posGroups.Defensa.length < 6 ||
    posGroups.Delantero.length < 2
  ) {
    if (!teamAlertShown) {
      alert('No hay suficientes jugadores para formar equipos completos respetando m√≠nimos por posici√≥n');
      teamAlertShown = true;
    }
    return null;
  }

  let bestTeams = null;
  let smallestDiff = Infinity;
  const iterations = 500;

  for (let it = 0; it < iterations; it++) {
    let teamA = [], teamB = [];

    const porteros = [...posGroups.Portero];
    const defensas = [...posGroups.Defensa];
    const delanteros = [...posGroups.Delantero];
    const otros = [...posGroups.Otros];

    shuffle(porteros);
    shuffle(defensas);
    shuffle(delanteros);
    shuffle(otros);

    teamA.push(porteros.shift());
    teamB.push(porteros.shift());

    teamA.push(...defensas.splice(0, 3));
    teamB.push(...defensas.splice(0, 3));

    teamA.push(delanteros.shift());
    teamB.push(delanteros.shift());

    const remaining = [...porteros, ...defensas, ...delanteros, ...otros];
    while (teamA.length < maxPlayers && remaining.length > 0) {
      teamA.push(remaining.shift());
    }
    while (teamB.length < maxPlayers && remaining.length > 0) {
      teamB.push(remaining.shift());
    }

    const diff = Math.abs(averageMedia(teamA) - averageMedia(teamB));
    if (diff < smallestDiff) {
      smallestDiff = diff;
      bestTeams = [teamA, teamB];
    }
  }

  if (!bestTeams || bestTeams[0].length !== 7 || bestTeams[1].length !== 7) {
    if (!teamAlertShown) {
      alert('No se pudieron generar equipos completos con los jugadores seleccionados');
      teamAlertShown = true;
    }
    return null;
  }

  return bestTeams;
}

function isDuplicate(proposals, newTeams) {
  const newStr = JSON.stringify(newTeams.map(t => t.map(p => p.name).sort()));
  return proposals.some(p => JSON.stringify(p.map(t => t.map(p2 => p2.name).sort())) === newStr);
}

// ---------------- GENERAR PROPUESTAS ----------------
function generateProposals(selected, optimized = false) {
  teamAlertShown = false; // üîπ Se reinicia cada vez que generamos propuestas
  currentProposals = [];
  let attempts = 0;

  while (currentProposals.length < 5 && attempts < 50) {
    const teams = generateTeams(selected, 2);

    if (!teams || !teams[0]?.length || !teams[1]?.length) {
      attempts++;
      continue;
    }

    if (!isDuplicate(currentProposals, teams)) currentProposals.push(teams);
    attempts++;
  }

  if (currentProposals.length === 0) {
    console.warn('No se pudieron generar equipos v√°lidos con los jugadores seleccionados');
    return;
  }

  renderProposals();
}


// --- BOTONES GENERAR ---
document.getElementById('generate').addEventListener('click', () => {
  const selectedIndexes = [...document.querySelectorAll('#playersContainer input:checked')]
    .map(chk => Number(chk.dataset.index));

  if (selectedIndexes.length < 5) {
    alert('Selecciona al menos 5 jugadores');
    return;
  }

  const selected = selectedIndexes.map(i => currentPlayers[i]).filter(Boolean);

  const count = { Portero: 0, Defensa: 0, Delantero: 0 };
  selected.forEach(p => count[p.pos] = (count[p.pos] || 0) + 1);

  if (count.Portero < 1 || count.Defensa < 3 || count.Delantero < 1) {
    alert('Debe haber al menos 1 portero, 3 defensas y 1 delantero seleccionados');
    return;
  }

  generateProposals(selected);
});

document.getElementById('generateOptimized').addEventListener('click', () => {
  const selectedIndexes = [...document.querySelectorAll('#playersContainer input:checked')]
    .map(chk => Number(chk.dataset.index));

  if (selectedIndexes.length < 5) {
    alert('Selecciona al menos 5 jugadores');
    return;
  }

  const selected = selectedIndexes.map(i => currentPlayers[i]).filter(Boolean);
  generateProposals(selected, true);
});

  function applyTeams(teams) {
  // Mostrar campos
  const field1 = document.getElementById('field1');
  const field2 = document.getElementById('field2');
  field1.style.display = 'block';
  field2.style.display = 'block';

  // Limpiar cualquier contenido previo
  field1.innerHTML = '<div class="field-title">Equipo Negro</div>';
  field2.innerHTML = '<div class="field-title">Equipo Blanco</div>';

}


// ---------------- RENDER PROPUESTAS ----------------
function renderProposals(){
  const container = document.getElementById('proposalsContainer');
  container.innerHTML = '';

  currentProposals.forEach((teams, i) => {
    const div = document.createElement('div');
    div.className = 'proposal';

    // Calcular media de cada equipo y diferencia
    const media1 = averageMedia(teams[0]);
    const media2 = averageMedia(teams[1]);
    const diff = Math.abs(media1 - media2).toFixed(2);

    // Mostrar diferencia de media
    const diffDiv = document.createElement('div');
    diffDiv.textContent = `Diferencia de media: ${diff}`;
    diffDiv.style.fontSize = '12px';
    diffDiv.style.color = '#aaa';
    div.appendChild(diffDiv);

    ['Equipo Negro', 'Equipo Blanco'].forEach((title, idx) => {
      const teamDiv = document.createElement('div');
      teamDiv.className = 'team-box';

      const tTitle = document.createElement('div');
      tTitle.className = 'team-title';
      tTitle.textContent = title;
      teamDiv.appendChild(tTitle);

      teams[idx].forEach(p => {
        const pDiv = document.createElement('div');
        pDiv.className = 'player-entry';
        pDiv.textContent = `${p.name} (${p.pos}) [${p.media}]`;
        teamDiv.appendChild(pDiv);
      });

      div.appendChild(teamDiv);
    });

    div.addEventListener('click', () => applyTeams(teams));
    container.appendChild(div);
  });

  document.getElementById('proposalsCard').style.display = 'block';
}

// ---------------- DIBUJAR CAMPO Y JUGADORES ----------------
function showField(teams){
  const field1=document.getElementById('field1');
  const field2=document.getElementById('field2');
  field1.innerHTML='<div class="field-title">Equipo Negro</div>';
  field2.innerHTML='<div class="field-title">Equipo Blanco</div>';
  field1.style.display='block';
  field2.style.display='block';
  drawField(field1);
  drawField(field2);
  drawTeamOnField(field1,teams[0],'black');
  drawTeamOnField(field2,teams[1],'white');
}

  // ---------------- DIBUJAR L√çNEAS DEL CAMPO ----------------
function drawField(field) {
  // Fondo verde s√≥lido
  field.style.backgroundColor = "#0f4720";
  field.style.position = "relative";
  field.style.border = "2px solid white";
  field.style.borderRadius = "8px";
  field.style.overflow = "hidden";
  // ---------------- DIBUJAR JUGADORES ----------------
function drawTeamOnField(field, team, color) {
  team.forEach(player => {
    const playerDiv = document.createElement("div");
    playerDiv.classList.add("player");
    playerDiv.style.position = "absolute";
    playerDiv.style.left = player.x + "%";
    playerDiv.style.top = player.y + "%";
    playerDiv.style.transform = "translate(-50%, -50%)";
    playerDiv.innerHTML = `
      <div class="shirt ${color}">${player.number}</div>
      <div class="player-name">${player.name}</div>
    `;
    field.appendChild(playerDiv);
  });
}


  // Dibujar l√≠neas internas con divs (mejor compatibilidad que canvas)
  const lines = document.createElement("div");
  lines.innerHTML = `
    <div style="
      position:absolute;top:50%;left:0;width:100%;height:2px;
      background:white;transform:translateY(-50%);
    "></div>
    <div style="
      position:absolute;top:0;left:50%;width:160px;height:100px;
      border:2px solid white;transform:translateX(-50%);
    "></div>
    <div style="
      position:absolute;bottom:0;left:50%;width:160px;height:100px;
      border:2px solid white;transform:translateX(-50%);
    "></div>
    <div style="
      position:absolute;top:50%;left:50%;width:80px;height:80px;
      border:2px solid white;border-radius:50%;
      transform:translate(-50%,-50%);
    "></div>
  `;
  field.appendChild(lines);
}


// ---------------- DRAG & DROP, SNAP Y RENDER DE JUGADORES ----------------
function drawTeamOnField(field, team, color){
  const fieldWidth = 320;
  const positionsY = { Delantero: 50, Mediocentro: 160, Defensa: 300, Portero: 410 };
  let mediocentro = null;
  const possibleMC = team.filter(p => p.pos === 'Mediocentro');
  if(possibleMC.length > 0) mediocentro = possibleMC[0];

  // Limpiamos jugadores previos
  field.querySelectorAll('.player-card').forEach(c => c.remove());

  ['Portero','Defensa','Mediocentro','Delantero','Otros'].forEach(cat => {
    let arr = team.filter(p => p.pos === cat || (cat==='Otros' && !['Portero','Defensa','Delantero','Mediocentro'].includes(p.pos)));
    if(mediocentro && cat!=='Mediocentro') arr = arr.filter(p=>p!==mediocentro);
    arr.forEach((p,i) => {
      const div = document.createElement('div');
      div.className = 'player-card';
      const img = document.createElement('img'); img.src = shirtImages[color]; div.appendChild(img);
      const span = document.createElement('span'); span.textContent = p.name; div.appendChild(span);
      const y = p===mediocentro ? positionsY.Mediocentro : positionsY[p.pos] || 50;
      const spacing = fieldWidth / (arr.length+1);
      div.style.top = y + 'px';
      div.style.left = (spacing*(i+1)-20)+'px';
      field.appendChild(div);
      makeDraggable(div, field, positionsY);
    });
  });
}

function makeDraggable(el, field, positionsY){
  let offsetX, offsetY;

  function startDrag(clientX, clientY){
    const rect = el.getBoundingClientRect();
    offsetX = clientX - rect.left;
    offsetY = clientY - rect.top;
  }

  function onMove(clientX, clientY){
    let x = clientX - field.getBoundingClientRect().left - offsetX;
    let y = clientY - field.getBoundingClientRect().top - offsetY;
    x = Math.max(0, Math.min(field.clientWidth - el.clientWidth, x));
    y = Math.max(0, Math.min(field.clientHeight - el.clientHeight, y));
    el.style.left = x+'px';
    el.style.top = y+'px';
  }

  function endDrag(clientX){
    let posY = parseFloat(el.style.top);
    // Snap vertical
    let closest = Object.values(positionsY).reduce((a,b) => Math.abs(b-posY)<Math.abs(a-posY)?b:a);
    el.style.top = closest+'px';

    // Reordenar horizontalmente
    const linePlayers = Array.from(field.querySelectorAll('.player-card')).filter(p=>parseFloat(p.style.top)===closest);
    const sorted = linePlayers.sort((a,b)=>parseFloat(a.style.left)-parseFloat(b.style.left));
    const spacing = field.clientWidth / (sorted.length+1);
    sorted.forEach((p,i)=>{ p.style.left = (spacing*(i+1)-20)+'px'; });
  }

  // Rat√≥n
  el.onmousedown = e => {
    e.preventDefault();
    startDrag(e.clientX,e.clientY);
    document.onmousemove = mm;
    document.onmouseup = mu;
  }
  function mm(e){ onMove(e.clientX,e.clientY); }
  function mu(e){ endDrag(e.clientX); document.onmousemove=null; document.onmouseup=null; }

  // T√°ctil
  el.ontouchstart = e => {
    const t = e.touches[0];
    startDrag(t.clientX, t.clientY);
  }
  el.ontouchmove = e => {
    e.preventDefault();
    const t = e.touches[0];
    onMove(t.clientX,t.clientY);
  }
  el.ontouchend = e => { endDrag(); }
}

// ---------------- EXPORTAR UN CAMPO (REEMPLAZAR exportField) ----------------
async function exportField(fieldId) {
  const field = document.getElementById(fieldId);
  if (!field) return alert("No se encontr√≥ el campo.");

  // Esperar un frame adicional antes de capturar
  await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

  // Forzar opacidad y fondo s√≥lido temporalmente
  field.style.opacity = "1";
  field.style.mixBlendMode = "normal";
  field.style.filter = "none";
  field.style.backgroundColor = "#0f4720";

  // Captura estable
  const canvas = await html2canvas(field, {
    backgroundColor: "#0f4720",
    scale: 2,
    useCORS: true,
    logging: false,
    removeContainer: true,
    allowTaint: true, // importante para PNGs sin cabeceras CORS
    willReadFrequently: true
  });

  // Forzar canal alpha a 1 en todo el canvas
  const ctx = canvas.getContext("2d", { willReadFrequently: true });
  const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  for (let i = 3; i < imgData.data.length; i += 4) {
    imgData.data[i] = 255;
  }
  ctx.putImageData(imgData, 0, 0);

  // Descargar imagen
  const link = document.createElement("a");
  link.download = `${fieldId}.png`;
  link.href = canvas.toDataURL("image/png", 1.0);
  link.click();
}

async function exportarAmbosAlineaciones() {
  const field1 = document.getElementById("field1");
  const field2 = document.getElementById("field2");
  if (!field1 || !field2) return alert("No se encontraron los campos.");

  const titulo = prompt("Introduce el t√≠tulo para la imagen:", "‚öΩ Partido ‚öΩ");

  // Esperar 2 frames para asegurar render final
  await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

  // Capturar con fondo forzado
  const [canvas1, canvas2] = await Promise.all([
    html2canvas(field1, {
      backgroundColor: "#0f4720",
      scale: 2,
      useCORS: true,
      logging: false,
      allowTaint: true
    }),
    html2canvas(field2, {
      backgroundColor: "#0f4720",
      scale: 2,
      useCORS: true,
      logging: false,
      allowTaint: true
    })
  ]);

  const spacing = 40;
  const padding = 40;
  const topMargin = 60;
  const bottomMargin = 40;
  const totalWidth = canvas1.width * 2 + spacing + padding * 2;
  const totalHeight = Math.max(canvas1.height, canvas2.height) + topMargin + bottomMargin;

  const combinedCanvas = document.createElement("canvas");
  combinedCanvas.width = totalWidth;
  combinedCanvas.height = totalHeight;
  const ctx = combinedCanvas.getContext("2d", { willReadFrequently: true });

  // Fondo gris claro
  ctx.fillStyle = "#d9d9d9";
  ctx.fillRect(0, 0, totalWidth, totalHeight);

  // T√≠tulo centrado
  ctx.fillStyle = "#222";
  ctx.font = "bold 28px Arial";
  ctx.textAlign = "center";
  ctx.fillText(titulo || "‚öΩ Partido ‚öΩ", totalWidth / 2, 40);

  const yOffset = topMargin;
  const x1 = padding;
  const x2 = padding + canvas1.width + spacing;

  // Dibujar im√°genes (forzando alpha = 1)
  ctx.drawImage(canvas1, x1, yOffset);
  ctx.drawImage(canvas2, x2, yOffset);

  const imgData = ctx.getImageData(0, 0, combinedCanvas.width, combinedCanvas.height);
  for (let i = 3; i < imgData.data.length; i += 4) {
    imgData.data[i] = 255;
  }
  ctx.putImageData(imgData, 0, 0);

  // Descargar imagen
  const link = document.createElement("a");
  link.download = "alineaciones_whatsapp.png";
  link.href = combinedCanvas.toDataURL("image/png", 1.0);
  link.click();
}


// --- Asociar bot√≥n ---
document.getElementById('exportarAmbosBtn').addEventListener('click', exportarAmbosAlineaciones);

</script>
  
</body>
</html>
